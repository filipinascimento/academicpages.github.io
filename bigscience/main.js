import*as I from"./web_modules/d3.js";import*as J from"./web_modules/d3-geo-projection.js";import*as x from"../../src/utils/xnet.js";import K from"./web_modules/nouislider.js";import"./web_modules/nouislider/distribute/nouislider.css.proxy.js";import"./customSliders.css.proxy.js";import*as j from"./utilities.js";import"./mingle/kdtree.js";import"./mingle/graph.js";import"./mingle/mingle.js";import"./web_modules/d3-geo-zoom.js";const f=Object.assign({},I,J);let L=a=>f.text(`https://raw.githubusercontent.com/1313e/CMasher/master/cmasher/colormaps/${a}/${a}_8bit.txt`).then(b=>f.dsvFormat(" ").parseRows(b,d=>f.rgb(d[0],d[1],d[2]))).then(b=>d=>b[Math.floor(d*(b.length-1e-7))]);const o={"research center":"#1f77b4",university:"#ff7f0e",college:"#2ca02c",other:"#d62728"};export class HeliosMap{constructor({elementID:a,projectName:b,mapColor:d="#B1C3B6",projectColor:e=CC006B,projection:c=f.geoRobinson().rotate([-10,0])}){this.projectName=b,this.mapColor=d,this.projectColor=e,this.element=document.getElementById(a),this.element.innerHTML="",this.element.classList.add("scaffold"),this.plotView=document.createElement("div"),this.plotView.classList.add("plotView"),this.element.appendChild(this.plotView),this.canvasElement=document.createElement("canvas"),this.plotView.appendChild(this.canvasElement),this.canvasElement.classList.add("edgesView"),this.context=this.canvasElement.getContext("2d"),this.nodesElement=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.nodesElement.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),this.nodesElement.classList.add("nodesView"),this.plotView.appendChild(this.nodesElement),this.mapContext=this.context,this.loaderContainer=document.createElement("div"),this.loaderContainer.classList.add("loaderContainer"),this.loaderElement=document.createElement("div"),this.loaderElement.classList.add("loader"),this.loaderTextElement=document.createElement("div"),this.loaderTextElement.classList.add("loaderText"),this.loaderContainer.appendChild(this.loaderElement),this.loaderContainer.appendChild(this.loaderTextElement),this.element.appendChild(this.loaderContainer),this.buttonsPanelElement=document.createElement("div"),this.buttonsPanelElement.classList.add("buttonsPanel"),this.inputPanelElement=document.createElement("div"),this.inputPanelElement.classList.add("inputPanel"),this.sliderElement=document.createElement("div"),this.sliderElement.classList.add("timeSlider"),this.element.appendChild(this.buttonsPanelElement),this.buttonsPanelElement.appendChild(this.inputPanelElement),this.inputPanelElement.appendChild(this.sliderElement),this.globalLinks=!1,this.projection=c,this.geoPath=f.geoPath().projection(this.projection),this.geoPathCanvas=f.geoPath().projection(this.projection).context(this.mapContext),this.transform=new j.RegularTransform({x:0,y:0,k:1}),this.zoom=f.zoom().scaleExtent([1,100]).on("zoom",g=>{this.transform=new j.RegularTransform(g.transform),this.updateProjection(),this.update()}),f.select(this.canvasElement).call(this.zoom),f.select(this.nodesElement).call(this.zoom),this.initialize(),window.onresize=g=>{this.willResizeEvent(g)}}async initialize(){this.colormap=await L("amber"),this.countryData=await f.json("world-110m.geojson"),this.progressbar=f.select(this.loaderContainer),this.progresstext=f.select(this.loaderTextElement),this.progresstext.text("Loading data..."),this.linksPanel=f.select(this.nodesElement).append("g").classed("links",!0),this.nodesPanel=f.select(this.nodesElement).append("g").classed("nodes",!0),this.selectedNodes=new Set(),this.hoverNode=null,this.selectedView=f.select(this.nodesElement).append("g").selectAll(".nodesSelected");let a=await x.loadXNETFile(`data/institutions_${this.projectName}.xnet`);await this.setNetwork(a),await this.setupNodesView(),await this.willResizeEvent(0),this.timeSlider.on("update",async b=>{this.minYear=parseInt(b[0]),this.maxYear=parseInt(b[1]),await this.update()})}async updateProjection(){this.width=this.plotView.clientWidth,this.height=this.plotView.clientHeight,this.projection.fitExtent([[5,5],[this.width-5,this.height-5]],{type:"Sphere"});let a=this.projection.translate();this.projection.translate([this.transform.x+this.transform.k*a[0],this.transform.y+this.transform.k*a[1]]),this.projection.scale(this.projection.scale()*this.transform.k),this.zoom.translateExtent([[5,5],[this.width-5,this.height-5]])}async willResizeEvent(){this.linksPlotData=null;let a=this.plotView.clientWidth,b=this.plotView.clientHeight,d=window.devicePixelRatio||1,e=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1;this.contextPixelRatio=d/e,this.canvasElement.style.width=a+"px",this.canvasElement.style.height=b+"px",this.nodesElement.setAttribute("height",""+b),this.nodesElement.setAttribute("width",""+a),this.canvasElement.width=this.contextPixelRatio*this.plotView.clientWidth,this.canvasElement.height=this.contextPixelRatio*this.plotView.clientHeight,this.context.setTransform(1,0,0,1,0,0),this.context.scale(this.contextPixelRatio,this.contextPixelRatio),this.previousGlobalLink=!1,this.updateProjection(),this.update()}async updateBackground(){this.mapContext.save(),this.mapContext.strokeStyle="#dddddd",this.mapContext.fillStyle="#f9fcff",this.mapContext.beginPath(),this.geoPathCanvas({type:"Sphere"}),this.mapContext.fill(),this.mapContext.stroke(),this.mapContext.strokeStyle="#dddddd",this.mapContext.fillStyle=this.mapColor,this.mapContext.beginPath(),this.geoPathCanvas(this.countryData),this.mapContext.fill(),this.mapContext.stroke(),this.mapContext.restore()}async update(){this.yearsSet=new Set(Array.from({length:this.maxYear-this.minYear+1},(a,b)=>b+this.minYear)),await this.updateNodesPositions(),await this.updateNodesView(),await this.updateSelectedNodes(!0),this.context.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),await this.updateBackground(),this.renderLinks(),(!this.globalLinks||!this.previousGlobalLink)&&(this.progressbar.style("display",null),this.progresstext.text("Processing edges..."),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(async()=>{this.previousGlobalLink=this.globalLinks,await this.setupLinks(),this.progressbar.style("display","none")},1e3))}async setNetwork(a){this.network=a,this.nodes=[],this.minYear=null,this.maxYear=null;let b=0;for(let e=0;e<this.network.nodesCount;e++){let c={},g=this.network.verticesProperties;for(const i in g)Object.hasOwnProperty.call(g,i)&&(c[i]=g[i][e]);c.size=Math.pow(c.Strength,.5),b=Math.max(b,c.size),c.id=e,c.visible=!0,c.Name.startsWith("Unlisted")?c.unlisted=!0:c.unlisted=!1;if(Object.hasOwnProperty.call(c,"years")){c.years=new Set(c.years.split(" ").map(i=>parseInt(i)));for(const i of c.years)this.minYear==null?this.minYear=i:this.minYear=Math.min(this.minYear,i),this.maxYear==null?this.maxYear=i:this.maxYear=Math.max(this.maxYear,i)}this.nodes.push(c)}this.nodes.forEach(e=>{e.size=e.size/b*8+2,e.Field in o?e.color=o[e.Field]:e.color=o.other}),this.minRangeYear=this.minYear,this.maxRangeYear=this.maxYear;let d={to:e=>""+Math.round(e)};this.timeSlider=K.create(this.sliderElement,{start:[this.minYear,this.maxYear],step:1,behaviour:"tap-drag",tooltips:[d,d],connect:!0,range:{min:this.minYear,max:this.maxYear},pips:{mode:"steps",density:3,format:d}}),this.yearColor=f.scaleSequential(this.colormap).domain([this.minRangeYear,this.minRangeYear+(this.maxRangeYear-this.minRangeYear)]),this.edgesYears=this.network.edgesProperties.years.map(e=>new Set(e.split(" ").map(c=>parseInt(c)))),this.legendsElement=j.legend({color:f.scaleSequential([this.minRangeYear,this.maxRangeYear],this.colormap),title:"First year of collaboration",tickFormat:"d"}),this.legendsCategories=document.createElement("div"),j.swatches({color:o,columns:null,element:this.legendsCategories,format:e=>e.charAt(0).toUpperCase()+e.slice(1)}),this.legendsPanel=document.createElement("div"),this.legendsPanel.classList.add("legendsView"),this.legendsPanel.appendChild(this.legendsCategories),this.legendsPanel.appendChild(this.legendsElement),this.element.appendChild(this.legendsPanel)}async setupNodesView(){let a=this.nodesPanel.selectAll(".node").data(this.nodes);a.exit().remove();let b=this,d=a.enter().append("circle").classed("node",!0).attr("r",0).attr("fill",e=>e.color).attr("stroke",e=>f.rgb(e.color).darker(.85)).attr("stroke-width","1.5px").on("mouseover",function(e,c){b.hoverNode=c,f.select(this).attr("r",c.size*1.25).attr("stroke",f.rgb(c.color).darker(1)).attr("stroke-width",3),b.updateSelectedNodes(),e.stopPropagation()}).on("mouseout",function(e,c){f.select(this).attr("r",g=>g.size).attr("stroke",g=>f.rgb(g.color).darker(.85)).attr("stroke-width",1.5),b.hoverNode=null,b.updateSelectedNodes(),e.stopPropagation()}).on("click",function(e,c){e.shiftKey||b.selectedNodes.clear(),b.selectedNodes.has(c.id)?(console.log("unselecting "+c.id),b.selectedNodes.delete(c.id)):(console.log("selecting "+c.id),b.selectedNodes.add(c.id)),b.updateSelectedNodes(),e.stopPropagation()});f.select(this.nodesElement).on("click",function(e,c){e.shiftKey||(b.selectedNodes.clear(),b.updateSelectedNodes())}),d.transition().duration(500).attr("r",e=>e.size),this.nodesView=d.merge(a)}async updateNodesView(){this.nodesView.attr("cx",a=>a.x).attr("cy",a=>a.y).style("display",a=>a.visible?null:"none")}async updateNodesPositions(){this.nodes.forEach(a=>{let b=this.projection(a.Position);a.x=b[0],a.y=b[1],a.x<0||a.y<0||a.x>this.width||a.y>this.height?a.outOfBounds=!0:a.outOfBounds=!1;let d=j.setIntersection(this.yearsSet,a.years);a.outOfBounds||a.unlisted||d.size==0?a.visible=!1:a.visible=!0})}async updateSelectedNodes(a=!1){let b=-10;if(!a){let d=Array.from(this.selectedNodes).map(g=>this.nodes[g]).filter(g=>g);this.hoverNode&&!this.selectedNodes.has(this.hoverNode.id)&&d.push(this.hoverNode),this.selectedView=this.selectedView.data(d),this.selectedView.exit().remove();let e=this.selectedView.enter().append("g").classed("nodesSelected",!0).classed("nointeraction",!0);e.append("path").attr("d",`M ${-b*1},${b+3} L ${0},${0} L ${+b*1},${b+3} z`);let c=e.append("g").attr("transform",(g,i)=>"translate("+0+","+b+")").classed("textbox",!0);c.append("text").classed("outline",!0),c.append("text").classed("name",!0),this.selectedView=e.merge(this.selectedView)}this.selectedView.attr("transform",(d,e)=>"translate("+d.x+","+d.y+")"),this.selectedView.select(".name").attr("fill",d=>f.rgb(d.color).darker(1)).attr("font-size","15px").attr("text-anchor","middle").text(d=>d.Name),this.selectedView.select(".outline").attr("fill","white").attr("stroke","white").attr("stroke-width",3).attr("font-size","15px").attr("text-anchor","middle").style("opacity",.9).text(d=>d.Name),this.selectedView.select("path").attr("fill",d=>f.rgb(d.color).darker(1)).attr("stroke","white").style("opacity",.9).attr("stroke-width",1)}async setupLinks(){let a=this.network.edgesProperties.year,b=this.network.weights.map(h=>1/h),d=this.network.weights.map(h=>h),e=this.network.edges,c=this.nodes,g=[],i=[];for(let h=0;h<e.length;h++){let k=e[h],l=k[0],m=k[1];if(!this.globalLinks&&!c[l].visible&&!c[m].visible)continue;let q=j.setIntersection(this.yearsSet,this.edgesYears[h]);q.size>0&&(!this.globalLinks&&(!c[l].visible||!c[m].visible)&&(b[h]*=4),g.push(h))}g.sort((h,k)=>b[h]-b[k]);if(g.length==0)return;g=g.slice(0,1e3);let t=[],z=f.extent(g.map(h=>d[h])),u=f.extent(d);g.forEach(h=>{let k=e[h],l=k[0],m=k[1],q=c[l],E=c[m],F=!this.globalLinks&&(!q.visible||!E.visible),r=d[h],G=a[h],s=f.color(this.yearColor(G));s.opacity=.1*r/u[1]+.1*r/z[1]+.05,F&&(s.opacity=.025);let H={id:`${l}:${m}`,name:`${l}:${m}`,data:{weight:(2+r/u[1]*2)*1,color:s.formatRgb(),edgeIndex:h,coords:[c[l].x,c[l].y,c[m].x,c[m].y]}};t.push(H)});let A=1,B=0,C="QuadraticSAVE",v=1,w=3,D=15,n=new Bundler();n.options.angleStrength=w,n.options.sort=null,n.setNodes(t),n.buildNearestNeighborGraph(D),n.MINGLE(),this.bundle=n,this.linksPlotData=[],n.graph.each(h=>{let k=h.unbundleEdges(v);Bundler.Graph["render"+C](this.linksPlotData,k,{margin:B,delta:v,angleStrength:w,curviness:A,scale:1})}),this.linkTransform=new j.RegularTransform({x:this.transform.x,y:this.transform.y,k:this.transform.k}),this.context.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),this.updateBackground(),this.renderLinks()}renderLinks(){if(this.linksPlotData){this.context.save();let a=1;this.context.translate(this.transform.x,this.transform.y),this.context.scale(this.transform.k,this.transform.k),a*=this.transform.k;if(this.linkTransform){let b=this.linkTransform.inverse();this.context.translate(b.x,b.y),this.context.scale(b.k,b.k),a*=b.k}this.linksPlotData.forEach(b=>{let d=b.edgeIndex,e=j.setIntersection(this.yearsSet,this.edgesYears[d]);if(e.size==0)return;this.context.strokeStyle=b.color,this.context.lineWidth=b.width/a,this.context.stroke(b.path)}),this.context.restore()}}renderLinksSVG(){if(this.linkTransform){let d=this.linkTransform.inverse();this.linksPanel.attr("transform",this.transform+" "+d)}else this.linksPanel.attr("transform",this.transform);let a=this.linksPanel.selectAll(".link").data(this.linksPlotData.filter(d=>{let e=d.edgeIndex,c=j.setIntersection(this.yearsSet,this.edgesYears[e]);return c.size==0?!1:!0}));a.exit().remove();let b=a.enter().append("path").classed("link",!0).attr("fill","none").attr("vector-effect","non-scaling-stroke");this.linksView=b.merge(a),this.linksView.attr("stroke",d=>d.color).attr("stroke-width",d=>d.width+"px").attr("d",d=>{let e=f.path();if(d.hasOwnProperty("moveTo")){let c=d.moveTo;e.moveTo(c[0],c[1])}if(d.hasOwnProperty("bezierCurveTo1")){let[c,g,i]=d.bezierCurveTo1;e.bezierCurveTo(c[0],c[1],g[0],g[1],i[0],i[1])}if(d.hasOwnProperty("lineTo")){let c=d.lineTo;e.lineTo(c[0],c[1])}if(d.hasOwnProperty("bezierCurveTo2")){let[c,g,i]=d.bezierCurveTo2;e.bezierCurveTo(c[0],c[1],g[0],g[1],i[0],i[1])}return e})}}let p={atlas:{name:"ATLAS",mapColor:"#B1C3B6",color:"#008758"},babar:{name:"BaBar",mapColor:"#BBB2B6",color:"#CC006B"},ligo:{name:"LIGO",mapColor:"#B1A58C",color:"#903C22"},icecube:{name:"IceCube",mapColor:"#AFB9C9",color:"#1E6099"}},M=["babar","atlas","ligo","icecube"];f.select("#selectionmenu").selectAll("a").data(M).enter().append("a").attr("href",a=>"#"+p[a].name).style("--color",a=>p[a].color).append("span").text(a=>p[a].name);function y(){let a=location.hash.substring(1).toLowerCase(),b=p[a];f.selectAll("#selectionmenu").selectAll("a").classed("selected",d=>d==a),window.heliosMap=new HeliosMap({elementID:"netviz",projectName:b.name,mapColor:b.mapColor,projectColor:b.color})}window.addEventListener("hashchange",y),f.select(".question").on("click",function(a,b){f.select("#helpscreen").style("display")=="none"?f.select("#helpscreen").style("display",null):f.select("#helpscreen").style("display","none")}),f.select("#helpscreen").on("click",function(a,b){f.select("#helpscreen").style("display","none")}),window.location.hash?y():window.location.hash="#ATLAS";
