(function(){/**
 * k-d Tree JavaScript - V 1.0
 *
 * https://github.com/ubilabs/kd-tree-javascript
 *
 * @author Mircea Pricop <pricop@ubilabs.net>, 2012
 * @author Martin Kleppe <kleppe@ubilabs.net>, 2012
 * @author Ubilabs http://ubilabs.net, 2012
 * @license MIT License <http://www.opensource.org/licenses/mit-license.php>
 */function w(h,m,e){this.obj=h,this.left=null,this.right=null,this.parent=e,this.dimension=m}function z(h,m,e){var k=this;function u(a,f,c){var j=f%e.length,b,d;return a.length===0?null:a.length===1?new w(a[0],j,c):(a.sort(function(s,g){return s[e[j]]-g[e[j]]}),b=Math.floor(a.length/2),d=new w(a[b],j,c),d.left=u(a.slice(0,b),f+1,d),d.right=u(a.slice(b+1),f+1,d),d)}function x(a){k.root=a;function f(c){c.left&&(c.left.parent=c,f(c.left)),c.right&&(c.right.parent=c,f(c.right))}f(k.root)}Array.isArray(h)?this.root=u(h,0,null):x(h,m,e),this.toJSON=function(a){a||(a=this.root);var f=new w(a.obj,a.dimension,null);return a.left&&(f.left=k.toJSON(a.left)),a.right&&(f.right=k.toJSON(a.right)),f},this.insert=function(a){function f(d,s){if(d===null)return s;var g=e[d.dimension];return a[g]<d.obj[g]?f(d.left,d):f(d.right,d)}var c=f(this.root,null),j,b;if(c===null){this.root=new w(a,0,null);return}j=new w(a,(c.dimension+1)%e.length,c),b=e[c.dimension],a[b]<c.obj[b]?c.left=j:c.right=j},this.remove=function(a){var f;function c(b){if(b===null)return null;if(b.obj===a)return b;var d=e[b.dimension];return a[d]<b.obj[d]?c(b.left,b):c(b.right,b)}function j(b){var d,s,g;function r(i,n){var o,t,l,q,p;return i===null?null:(o=e[n],i.dimension===n?i.right!==null?r(i.right,n):i:(t=i.obj[o],l=r(i.left,n),q=r(i.right,n),p=i,l!==null&&l.obj[o]>t&&(p=l),q!==null&&q.obj[o]>p.obj[o]&&(p=q),p))}function v(i,n){var o,t,l,q,p;return i===null?null:(o=e[n],i.dimension===n?i.left!==null?v(i.left,n):i:(t=i.obj[o],l=v(i.left,n),q=v(i.right,n),p=i,l!==null&&l.obj[o]<t&&(p=l),q!==null&&q.obj[o]<p.obj[o]&&(p=q),p))}if(b.left===null&&b.right===null){if(b.parent===null){k.root=null;return}g=e[b.parent.dimension],b.obj[g]<b.parent.obj[g]?b.parent.left=null:b.parent.right=null;return}b.left!==null?d=r(b.left,b.dimension):d=v(b.right,b.dimension),s=d.obj,j(d),b.obj=s}f=c(k.root);if(f===null)return;j(f)},this.nearest=function(a,f,c){var j,b,d;d=new y(function(g){return-g[1]});function s(g){var r,v=e[g.dimension],i=m(a,g.obj),n={},o,t,l;function q(p,A){d.push([p,A]),d.size()>f&&d.pop()}for(l=0;l<e.length;l+=1)l===g.dimension?n[e[l]]=a[e[l]]:n[e[l]]=g.obj[e[l]];o=m(n,g.obj);if(g.right===null&&g.left===null){(d.size()<f||i<d.peek()[1])&&q(g,i);return}g.right===null?r=g.left:g.left===null?r=g.right:a[v]<g.obj[v]?r=g.left:r=g.right,s(r),(d.size()<f||i<d.peek()[1])&&q(g,i),(d.size()<f||Math.abs(o)<d.peek()[1])&&(r===g.left?t=g.right:t=g.left,t!==null&&s(t))}if(c)for(j=0;j<f;j+=1)d.push([null,c]);for(s(k.root),b=[],j=0;j<f;j+=1)d.content[j]&&b.push([d.content[j][0].obj,d.content[j][1]]);return b},this.balanceFactor=function(){function a(c){return c===null?0:Math.max(a(c.left),a(c.right))+1}function f(c){return c===null?0:f(c.left)+f(c.right)+1}return a(k.root)/(Math.log(f(k.root))/Math.log(2))}}function y(h){this.content=[],this.scoreFunction=h}y.prototype={push:function(h){this.content.push(h),this.bubbleUp(this.content.length-1)},pop:function(){var h=this.content[0],m=this.content.pop();return this.content.length>0&&(this.content[0]=m,this.sinkDown(0)),h},peek:function(){return this.content[0]},remove:function(h){for(var m=this.content.length,e=0;e<m;e++)if(this.content[e]==h){var k=this.content.pop();e!=m-1&&(this.content[e]=k,this.scoreFunction(k)<this.scoreFunction(h)?this.bubbleUp(e):this.sinkDown(e));return}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(h){for(var m=this.content[h];h>0;){var e=Math.floor((h+1)/2)-1,k=this.content[e];if(this.scoreFunction(m)<this.scoreFunction(k))this.content[e]=m,this.content[h]=k,h=e;else break}},sinkDown:function(h){for(var m=this.content.length,e=this.content[h],k=this.scoreFunction(e);;){var u=(h+1)*2,x=u-1,a=null;if(x<m){var f=this.content[x],c=this.scoreFunction(f);c<k&&(a=x)}if(u<m){var j=this.content[u],b=this.scoreFunction(j);b<(a==null?k:c)&&(a=u)}if(a!=null)this.content[h]=this.content[a],this.content[a]=e,h=a;else break}}},window.KdTree=z})();
