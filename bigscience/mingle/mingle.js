import"../web_modules/d3.js";(function(){Math.PHI=(1+Math.sqrt(5))/2;function L(a,b){var c=a[0]-b[0],f=a[1]-b[1];return Math.sqrt(c*c+f*f)}function y(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])}function M(a){var b=y(a);return H(1/b,a)}function u(a,b,c){return[a[0]*(1-c)+b[0]*c,a[1]*(1-c)+b[1]*c]}function N(a,b){return[a[0]+b[0],a[1]+b[1]]}function G(a,b){return[a[0]-b[0],a[1]-b[1]]}function P(a,b){return a[0]*b[0]+a[1]*b[1]}function H(a,b){return[b[0]*a,b[1]*a]}function aa(a,b,c){return[u(a[0],b[0],c),u(a[1],b[1],c)]}function ba(a){return JSON.parse(JSON.stringify(a))}function Q(a){var b,c=a.length,f=Array(a.length);for(b=0;b<c;++b)f[b]={node:a[b].node,pos:a[b].pos,normal:a[b].normal&&a[b].normal.slice()};return f}function R(a,b,c){var f=a.data.coords,e,h,i,j;b.length||b.push([(f[0]+f[2])/2,(f[1]+f[3])/2]),b.unshift([f[0],f[1]]),b.push([f[2],f[3]]),j=a.data.parents;if(j)for(e=0,h=j.length;e<h;++e)R(j[e],b.slice(),c);else c.push(b)}function ca(a,b){var c=a||b,f,e,h;return(!a||!b)&&(e=c.data.coords,f=[e[2]-e[0],e[3]-e[1]],h=[-f[1],f[0]],h=H(h,1/y(h))),h}function E(a,b,c,f){return{node:a,pos:b,normal:null}}function O(a,b,c){var f=a.data.coords,e,h,i,j,d,g;j=a.data.parents;if(j)for(e=0,h=j.length;e<h;++e)d=b.slice(),d.length||(i=[(f[0]+f[2])/2,(f[1]+f[3])/2],g=E(a,i,e,h),d.push(g)),g=E(a,[f[0],f[1]],e,h),d.unshift(g),g=E(a,[f[2],f[3]],e,h),d.push(g),O(j[e],d,c);else d=b.slice(),d.length||(i=[(f[0]+f[2])/2,(f[1]+f[3])/2],g=E(a,i,0,1),d.push(g)),g=E(a,[f[0],f[1]],0,1),d.unshift(g),g=E(a,[f[2],f[3]],0,1),d.push(g),c.push(d)}Graph.Node.prototype.expandEdges=function(){if(this.expandedEdges)return this.expandedEdges;var a=[];return O(this,[],a),this.expandedEdges=a,a},Graph.Node.prototype.unbundleEdges=function(a){var b=this.expandEdges(),c=Array(b.length),f=Math.min,e,h,i,j,d,g,k,m,l,n,o,s,z,p,q,t,v,w;a=a||0,this.unbundledEdges=this.unbundledEdges||{};if((a===0||a===1)&&this.unbundledEdges[a])return this.unbundledEdges[a];for(e=0,h=b.length;e<h;++e){for(d=b[e],w=d.length-1,g=Q(d),m=d[0].pos,l=d[w].pos,n=G(l,m),g[0].unbundledPos=g[0].pos.slice(),k=G(g[1].pos,g[0].pos),k=M([-k[1],k[0]]),g[0].normal=k,g[w].unbundledPos=g[d.length-1].pos.slice(),k=G(g[w].pos,g[w-1].pos),k=M([-k[1],k[0]]),g[w].normal=k,i=1,j=d.length-1;i<j;++i)o=d[i].pos,s=G(o,m),p=P(s,n),q=L(l,m),t=q*q,v=p/t,z=N(m,H(v,n)),g[i].unbundledPos=u(z,o,a),k=G(g[i+1].pos,g[i-1].pos),k=M([-k[1],k[0]]),g[i].normal=k;c[e]=g}return(a===0||a===1)&&(this.unbundledEdges[a]=c),c},Graph.Render={renderLine:function(a,b,c){c=c||{};var f=c.lineWidth||1,e=c.fillStyle||"gray",h,i,j,d,g,k;for(a.fillStyle=e,a.lineWidth=f,h=0,i=b.length;h<i;++h){for(g=b[h],a.beginPath(),j=0,d=g.length;j<d;++j)k=g[j].unbundledPos,j==0?a.moveTo(k[0],k[1]):a.lineTo(k[0],k[1]);a.stroke(),a.closePath()}},renderQuadratic:function(a,b,c){c=c||{};var f=c.lineWidth||1,e=c.fillStyle||"gray",h=c.adjustPosition||!1,i=(c.margin||0)*(c.delta||0),j,d,g,k,m,l,n,o,s,z,p,q,t,v,w,S,T,U,V,J,K,A,B,x,W,C,r,D,X,Y,Z,_,$;for(a.fillStyle=e,a.lineWidth=f,k=0,m=b.length;k<m;++k){for(s=b[k],x=null,C=null,r=s[0].node,a.lineWidth=(Math.max(1,r.data.weight)||1)*(c.scale||1),r.data.color&&Array.isArray(r.data.color)?(J=r.data.color[0],K=r.data.color[1],A=a.createLinearGradient(r.data.coords[0],r.data.coords[1],r.data.coords[2],r.data.coords[3]),A.addColorStop(0,J),A.addColorStop(.4,J),A.addColorStop(.6,K),A.addColorStop(1,K),a.strokeStyle=A):a.strokeStyle=r.data.color||a.strokeStyle,a.globalAlpha=r.data.alpha==void 0?1:r.data.alpha,a.beginPath(),l=0,o=s.length;l<o;++l)D=s[l],p=D.unbundledPos,l!==0&&(q=C||s[l-1].unbundledPos,h&&(p=this.adjustPosition(r.id,D,p,i,c.delta||0)),B=u(q,p,.5),t=u(q,B,l===1?0:c.curviness||0),w=p,v=u(B,w,l===o-1?1:1-(c.curviness||0)),x&&(a.moveTo(x[0],x[1]),a.quadraticCurveTo(q[0],q[1],t[0],t[1])),a.moveTo(t[0],t[1]),a.lineTo(v[0],v[1]),x=v,C=p);a.stroke(),a.closePath()}},renderQuadraticSAVE:function(a,b,c){c=c||{};var f=c.lineWidth||1,e=c.fillStyle||"gray",h=c.adjustPosition||!1,i=(c.margin||0)*(c.delta||0),j,d,g,k,m,l,n,o,s,z,p,q,t,v,w,S,T,U,V,J,K,A,B,x,W,C,r,D,X,Y,Z,_,$;for(k=0,m=b.length;k<m;++k){s=b[k],x=null,C=null,r=s[0].node;let F={width:(Math.max(1,r.data.weight)||1)*(c.scale||1),color:r.data.color||ctx.strokeStyle,edgeIndex:s[0].node.data.edgeIndex};for(F.path=new Path2D(),l=0,o=s.length;l<o;++l)D=s[l],p=D.unbundledPos,l!==0&&(q=C||s[l-1].unbundledPos,h&&(p=this.adjustPosition(r.id,D,p,i,c.delta||0)),B=u(q,p,.5),t=u(q,B,l===1?0:c.curviness||0),w=p,v=u(B,w,l===o-1?1:1-(c.curviness||0)),x&&(F.path.moveTo(x[0],x[1]),F.path.quadraticCurveTo(q[0],q[1],t[0],t[1])),F.path.moveTo(t[0],t[1]),F.path.lineTo(v[0],v[1]),x=v,C=p);a.push(F)}},adjustPosition:function(a,b,c,f,e){var h=b.node.data.nodeArray,i=1,j,d,g,k,m,l;if(h){for(j=h.length,d=Infinity,g=0,k=0,m=0;m<j;++m)l=h[m],l.id==a&&(d=m),m<d?g+=(l.data.weight||0)+f:m>d&&(k+=(l.data.weight||0)+f);c=N(c,H((g-(g+k)/2)*Math.min(i,e),b.normal))}return c},renderBezier:function(a,b,c){c=c||{};var f=c.curviness||0,e,h,i,j,d,g,k,m,l,n,o;for(e=0,h=b.length;e<h;++e)d=b[e],n=d[0].unbundledPos,a.strokeStyle=d[0].node.data.color||a.strokeStyle,a.lineWidth=d[0].node.data.weight||1,k=d[(d.length-1)/2].unbundledPos,d.length>3?(m=d[1].unbundledPos,l=d[(d.length-1)/2-1].unbundledPos,o=u(k,l,1-f),a.beginPath(),a.moveTo(n[0],n[1]),a.bezierCurveTo(m[0],m[1],l[0],l[1],o[0],o[1]),m=d[(d.length-1)/2+1].unbundledPos,l=d[d.length-2].unbundledPos,o=d[d.length-1].unbundledPos,1-f&&(n=u(k,m,1-f),a.lineTo(n[0],n[1])),a.bezierCurveTo(m[0],m[1],l[0],l[1],o[0],o[1]),a.stroke(),a.closePath()):(a.beginPath(),a.moveTo(n[0],n[1]),o=d[d.length-1].unbundledPos,a.lineTo(o[0],o[1]))},renderBezierSAVE:function(a,b,c){c=c||{};var f=c.curviness||0,e,h,i,j,d,g,k,m,l,n,o;for(e=0,h=b.length;e<h;++e){d=b[e],n=d[0].unbundledPos;let s=d[0].node.data.color||"#444444",z=d[0].node.data.weight||1,p={width:z,color:s,edgeIndex:d[0].node.data.edgeIndex};p.path=new Path2D(),k=d[(d.length-1)/2].unbundledPos,d.length>3?(m=d[1].unbundledPos,l=d[(d.length-1)/2-1].unbundledPos,o=u(k,l,1-f),p.path.moveTo(n[0],n[1]),p.path.bezierCurveTo(m[0],m[1],l[0],l[1],o[0],o[1]),m=d[(d.length-1)/2+1].unbundledPos,l=d[d.length-2].unbundledPos,o=d[d.length-1].unbundledPos,1-f&&(n=u(k,m,1-f),p.lineTo=n),p.path.bezierCurveTo(m[0],m[1],l[0],l[1],o[0],o[1])):(p.path.moveTo(n[0],n[1]),o=d[d.length-1].unbundledPos,p.path.lineTo(o[0],o[1])),a.push(p)}}};function I(a){this.options=a||{},this.graph=new Graph(),this.kdTree=null}return I.Graph=Graph.Render,I.prototype={setNodes:function(a){var b,c,f=this.graph;for(f.clear(),b=0,c=a.length;b<c;++b)f.addNode(a[b])},buildKdTree:function(){var a=[];this.graph.each(function(b){var c=b.data.coords;b.x=c[0],b.y=c[1],b.z=c[2],b.w=c[3],a.push(b)}),this.kdTree=new KdTree(a,function(b,c){var f=b.x-c.x,e=b.y-c.y,h=b.z-c.z,i=b.w-c.w;return Math.sqrt(f*f+e*e+h*h+i*i)},["x","y","z","w"])},buildNearestNeighborGraph:function(a){a=a||10;var b=this.graph,c,f,e;this.buildKdTree(),e=this.kdTree,b.each(function(h){var i=e.nearest(h,a),j,d;for(j=0,d=i.length;j<d;++j)c=i[j][0],f=i[j][1],c.id!=h.id&&b.addEdge(h,c)})},computeIntermediateNodePositions:function(a){var b,c,f,e,h,i,j,d,g;if(!a.data.nodes)return;f=this.getCentroids(a.data.nodes),d=this.costFunction.bind(this,a,f),e=0,h=1,i=.72,j=.1,g=this.goldenSectionSearch(e,h,i,j,d),d(g)},costFunction:function(a,b,c){var f,e,h,i,j,d,g;return c/=2,f=b[0],e=b[1],h=u(f,e,c),i=u(f,e,1-c),a.data.m1=h,a.data.m2=i,delete a.data.ink,j=this.getInkValue(a),d=this.getMaxTurningAngleValue(a,h,i),g=this.options.angleStrength||1.2,j*(1+Math.sin(d)/g)},goldenSectionSearch:function(a,b,c,f,e){var h=Math.PHI,i=2-Math.PHI,j=Math.abs,d;return c-b>b-a?d=b+i*(c-b):d=b-i*(b-a),j(c-a)<f*(j(b)+j(d))?(c+a)/2:e(d)<e(b)?c-b>b-a?this.goldenSectionSearch(b,d,c,f,e):this.goldenSectionSearch(a,d,b,f,e):c-b>b-a?this.goldenSectionSearch(a,b,d,f,e):this.goldenSectionSearch(d,b,c,f,e)},getCentroids:function(a){var b=[0,0],c=[0,0],f,e,h;for(e=0,h=a.length;e<h;++e)f=a[e].data.coords,b[0]+=f[0],b[1]+=f[1],c[0]+=f[2],c[1]+=f[3];return b[0]/=h,b[1]/=h,c[0]/=h,c[1]/=h,[b,c]},getInkValue:function(a,b){var c=a.data,f=Math.sqrt,e,h,i,j,d,g,k,m,l,n;b=b||0;if(!b&&(c.bundle||c.nodes)){for(l=c.bundle?c.bundle.data.nodes:c.nodes,j=c.m1,d=c.m2,g=0,k=0,m=l.length;k<m;++k)n=l[k],e=n.data.coords,h=j[0]-e[0],i=j[1]-e[1],g+=y([h,i]),h=d[0]-e[2],i=d[1]-e[3],g+=y([h,i]),g+=this.getInkValue(n,b+1);return b||(g+=L(j,d)),a.data.ink=g}if(c.parents){for(l=c.parents,j=[c.coords[0],c.coords[1]],d=[c.coords[2],c.coords[3]],g=0,k=0,m=l.length;k<m;++k)n=l[k],e=n.data.coords,h=j[0]-e[0],i=j[1]-e[1],g+=y([h,i]),h=d[0]-e[2],i=d[1]-e[3],g+=y([h,i]),g+=this.getInkValue(n,b+1);return b||(g+=L(j,d)),a.data.ink=g}return b?a.data.ink=0:(e=a.data.coords,h=e[0]-e[2],i=e[1]-e[3],a.data.ink=y([h,i]))},getMaxTurningAngleValue:function(a,b,c){var f=Math.sqrt,e=Math.abs,h=Math.acos,i=[b[0]-c[0],b[1]-c[1]],j=[-i[0],-i[1]],d=y(i),g=0,k,m,l,n,o,s,z,p,q,t,v;if(a.data.bundle||a.data.nodes){for(k=a.data.bundle?a.data.bundle.data.nodes:a.data.nodes,q=0,t=k.length;q<t;++q)p=k[q].data.coords,m=[p[0]-b[0],p[1]-b[1]],l=y(m),n=m[0]*i[0]+m[1]*i[1],o=e(h(n/l/d)),g=g<o?o:g,m=[p[2]-c[0],p[3]-c[1]],l=y(m),n=m[0]*j[0]+m[1]*j[1],o=e(h(n/l/d)),g=g<o?o:g;return g}return-1},getCombinedNode:function(a,b,c){a=a.data.bundle||a,b=b.data.bundle||b;var f=a.id+"-"+b.id,e=a.name+"-"+b.name,h=a.data.nodes||[a],i=b.data.nodes||[b],j=a.data.weight||0,d=b.data.weight||0,g=[],k;return a.id==b.id?a:(g.push.apply(g,h),g.push.apply(g,i),c=c||{},c.nodes=g,c.nodeArray=(a.data.nodeArray||[]).concat(b.data.nodeArray||[]),c.weight=j+d,k={id:f,name:e,data:c},this.computeIntermediateNodePositions(k),k)},coalesceNodes:function(a){var b=a[0],c=b.data,f=c.m1,e=c.m2,h=a.reduce(function(m,l){return m+(l.data.weight||0)},0),i=c.coords,j=c.bundle,d=[],g,k;if(f){for(i=[f[0],f[1],e[0],e[1]],g=0,k=a.length;g<k;++g)d.push.apply(d,a[g].data.nodeArray||(a[g].data.parents?[]:[a[g]]));return this.options.sort&&d.sort(this.options.sort),{id:j.id,name:j.id,data:{nodeArray:d,parents:a,coords:i,weight:h,parentsInk:j.data.ink}}}return a[0]},bundle:function(a,b,c){var f=this.graph;b.data.bundle=a,c.data.bundle=a,b.data.ink=a.data.ink,b.data.m1=a.data.m1,b.data.m2=a.data.m2,c.data.ink=a.data.ink,c.data.m1=a.data.m1,c.data.m2=a.data.m2},updateGraph:function(a,b,c,f){var e,h,i,j,d=function(g){var k=g.nodeTo.id;f[k]||j.push(g.nodeTo)};for(e=0,h=c.length;e<h;++e)i=c[e],j=[],i.eachEdge(d),a.removeNode(i.id);for(a.addNode(b),e=0,h=j.length;e<h;++e)a.addEdge(b,j[e])},coalesceGraph:function(){var a=this.graph,b=new Graph(),c={},f=-Infinity,e,h,i,j,d,g,k=this.updateGraph,m=this.coalesceNodes.bind(this);for(a.each(function(l){var n=l.data.group;f<n&&(f=n),c[n]||(c[n]={}),c[n][l.id]=l}),f++;f--;){j=c[f],e=[];for(h in j)e.push(j[h]);e.length&&(d=m(e),k(a,d,e,j))}},getMaximumInkSavingNeighbor:function(a){var b=a,c=this.getInkValue.bind(this),f=c(b),e=this.getCombinedNode.bind(this),h=Infinity,i=Array(2),j;return a.eachEdge(function(d){var g=d.nodeTo,k=c(g),m=e(b,g),l=c(m),n=l-(f+k);h>n&&(h=n,i[0]=b,i[1]=g,j=m)}),{bundle:i,inkTotal:h,combined:j}},MINGLE:function(){var a=this.graph,b=this,c=0,f=-1,e=0,h=0,i=function(d){d.data.group=f},j=function(d){if(d.data.group==f){var g=b.getMaximumInkSavingNeighbor(d),k=g.bundle,m=k[0],l=k[1],n=g.combined,o=-g.inkTotal;if(!m&&!l){e=-Infinity;return}o>0?(b.bundle(n,m,l),e+=o,l.data.group!=f?m.data.group=l.data.group:m.data.group=l.data.group=h):m.data.group=h,h++}};do e=0,h=0,a.each(i),a.each(j),this.coalesceGraph(),c+=e;while(e>0)}},window.Bundler=I,I})();
