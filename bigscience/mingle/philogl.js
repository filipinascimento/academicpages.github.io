(function(){(function(){var y=function(B,t){t=x.merge({context:{},camera:{fov:45,near:.1,far:500},program:{from:"defaults",vs:"Default",fs:"Default"},scene:{},textures:{src:[]},events:{},onLoad:x.empty,onError:x.empty},t||{});var g=t.context,q=t.camera,i=t.events,d=t.textures,k=x.splat(t.program),e=t.scene;n=y.WebGL.getContext(B,g);if(!n)return t.onError("The WebGL context couldn't been initialized"),null;var p={defaults:"fromDefaultShaders",ids:"fromShaderIds",sources:"fromShaderSources",uris:"fromShaderURIs"},c=k.length,h=function(){var l=c,s={},u=!1;return{onSuccess:function(a,b){s[b.id||c-l]=a,l--,l===0&&!u&&o(n,c==1?a:s,function(f){t.onLoad(f)})},onError:function(a){l--,t.onError(a),u=!0}}}();k.forEach(function(l,s){var u=l.from,a;for(var b in p)if(u==b){try{a=y.Program[p[b]](x.extend(h,l))}catch(f){h.onError(f)}break}a&&h.onSuccess(a,l)});function o(l,s,u){var a=l.canvas,b=new y.Camera(q.fov,q.aspect||a.width/a.height,q.near,q.far,q);b.update();var f=new y.Scene(s,b,e);U=new y.WebGL.Application({gl:l,canvas:a,program:s,scene:f,camera:b}),s.$$family=="program"&&s.use(),i&&y.Events.create(U,x.extend(i,{bind:U})),d.src.length?new y.IO.Textures(x.extend(d,{onComplete:function(){u(U)}})):u(U)}}})(),PhiloGL.unpack=function(y){y=y||ma,["Vec3","Mat4","Quat","Camera","Program","WebGL","O3D","Scene","Shaders","IO","Events","WorkerGroup","Fx","Media"].forEach(function(B){y[B]=PhiloGL[B]}),y.gl=n,y.Utils=x},PhiloGL.version="1.5.2";var n,U,ma=this;function x(y){return document.getElementById(y)}x.empty=function(){},x.time=Date.now,x.uid=function(){var y=x.time();return function(){return y++}}(),x.extend=function(y,B){for(var t in B)y[t]=B[t];return y},x.type=function(){var y=Object.prototype.toString,B=function(t){var g=y.call(t);return g.substr(8,g.length-9).toLowerCase()};return function(t){var g=B(t);return g!="object"?g:t.$$family?t.$$family:t&&t.nodeName&&t.nodeType==1?"element":g}}(),function(){function y(B){var t=x.type(B),g;if(t=="object"){g={};for(var q in B)g[q]=y(B[q]);return g}else if(t=="array"){g=[];for(var i=0,d=B.length;i<d;i++)g[i]=y(B[i]);return g}else return B}x.merge=function(){for(var B={},t=0,g=arguments.length;t<g;t++){var q=arguments[t];if(x.type(q)!="object")continue;for(var i in q){var d=q[i],k=B[i];k&&x.type(d)=="object"&&x.type(k)=="object"?B[i]=x.merge(k,d):B[i]=y(d)}}return B}}(),x.splat=function(){var y=Array.isArray;return function(B){return y(B)&&B||[B]}}(),function(){var y={getContext:function(t,g){var t=typeof t=="string"?x(t):t,q;q=t.getContext("experimental-webgl",g),q||(q=t.getContext("webgl",g));if(q&&g&&g.debug){n={};for(var i in q){var d=q[i];typeof d=="function"?n[i]=function(k,e){return function(){console.log(k,Array.prototype.join.call(arguments),Array.prototype.slice.call(arguments));try{var p=e.apply(q,arguments)}catch(o){throw k+" "+o}for(var c=[],h;(h=q.getError())!==q.NO_ERROR;)c.push(h);if(c.length)throw c.join();return p}}(i,d):n[i]=d}}else n=q;return n&&(n.get=function(k){return typeof k=="string"?n[k]:k}),n}};function B(t){for(var g in t)this[g]=t[g];this.buffers={},this.bufferMemo={},this.frameBuffers={},this.frameBufferMemo={},this.renderBuffers={},this.renderBufferMemo={},this.textures={},this.textureMemo={}}B.prototype={$$family:"application",setBuffer:function(t,g,q){if(q===!1||q===null){q=this.bufferMemo[g],q&&n.bindBuffer(q.bufferType,null);var i=q&&q.attribute||g,d=t.attributes[i];d!==void 0&&n.disableVertexAttribArray(d);return}q=x.extend(this.bufferMemo[g]||{bufferType:n.ARRAY_BUFFER,size:1,dataType:n.FLOAT,stride:0,offset:0,drawType:n.STATIC_DRAW},q||{});var i=q.attribute||g,k=q.bufferType,e=g in this.buffers,p=e?this.buffers[g]:n.createBuffer(),c="value"in q,h=q.value,o=q.size,l=q.dataType,s=q.stride,u=q.offset,a=q.drawType,d=t.attributes[i],b=d!==void 0;return e||(this.buffers[g]=p),b&&n.enableVertexAttribArray(d),n.bindBuffer(k,p),c&&n.bufferData(k,h,a),b&&n.vertexAttribPointer(d,o,l,!1,s,u),delete q.value,this.bufferMemo[g]=q,b&&(this.bufferMemo[i]=q),this},setBuffers:function(t,g){for(var q in g)this.setBuffer(t,q,g[q]);return this},setFrameBuffer:function(t,g){if(typeof g!="object"){n.bindFramebuffer(n.FRAMEBUFFER,g?this.frameBuffers[t]:null);return}g=x.merge(this.frameBufferMemo[t]||{width:0,height:0,bindToTexture:!1,textureOptions:{attachment:n.COLOR_ATTACHMENT0},bindToRenderBuffer:!1,renderBufferOptions:{attachment:n.DEPTH_ATTACHMENT}},g||{});var q=g.bindToTexture,i=g.bindToRenderBuffer,d=t in this.frameBuffers,k=d?this.frameBuffers[t]:n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,k),d||(this.frameBuffers[t]=k);if(q){var e=x.merge({data:{width:g.width,height:g.height}},x.type(q)=="object"?q:{}),p=t+"-texture",c=g.textureOptions;this.setTexture(p,e),n.framebufferTexture2D(n.FRAMEBUFFER,c.attachment,this.textureMemo[p].textureType,this.textures[p],0)}if(i){var h=x.extend({width:g.width,height:g.height},x.type(i)=="object"?i:{}),o=t+"-renderbuffer",l=g.renderBufferOptions;this.setRenderBuffer(o,h),n.framebufferRenderbuffer(n.FRAMEBUFFER,l.attachment,n.RENDERBUFFER,this.renderBuffers[o])}return n.bindTexture(n.TEXTURE_2D,null),n.bindRenderbuffer(n.RENDERBUFFER,null),n.bindFramebuffer(n.FRAMEBUFFER,null),this.frameBufferMemo[t]=g,this},setFrameBuffers:function(t){for(var g in t)this.setFrameBuffer(g,t[g]);return this},setRenderBuffer:function(t,g){if(typeof g!="object"){n.bindRenderbuffer(n.RENDERBUFFER,g?this.renderBufferMemo[t]:null);return}g=x.extend(this.renderBufferMemo[t]||{storageType:n.DEPTH_COMPONENT16,width:0,height:0},g||{});var q=t in this.renderBuffers,i=q?this.renderBuffers[t]:n.createRenderbuffer(n.RENDERBUFFER);return q||(this.renderBuffers[t]=i),n.bindRenderbuffer(n.RENDERBUFFER,i),n.renderbufferStorage(n.RENDERBUFFER,g.storageType,g.width,g.height),this.renderBufferMemo[t]=g,this},setRenderBuffers:function(t){for(var g in t)this.setRenderBuffer(g,t[g]);return this},setTexture:function(t,g){if(!g||typeof g!="object"){n.activeTexture(g||n.TEXTURE0),n.bindTexture(this.textureMemo[t].textureType||n.TEXTURE_2D,this.textures[t]);return}if(g.data&&g.data.type===n.FLOAT){if(!n.getExtension("OES_texture_float"))throw"OES_texture_float is not supported"}g=x.merge(this.textureMemo[t]||{textureType:n.TEXTURE_2D,pixelStore:[{name:n.UNPACK_FLIP_Y_WEBGL,value:!0},{name:n.UNPACK_ALIGNMENT,value:1}],parameters:[{name:n.TEXTURE_MAG_FILTER,value:n.NEAREST},{name:n.TEXTURE_MIN_FILTER,value:n.NEAREST},{name:n.TEXTURE_WRAP_S,value:n.CLAMP_TO_EDGE},{name:n.TEXTURE_WRAP_T,value:n.CLAMP_TO_EDGE}],data:{format:n.RGBA,value:!1,type:n.UNSIGNED_BYTE,width:0,height:0,border:0}},g||{});var q="textureType"in g?g.textureType=n.get(g.textureType):n.TEXTURE_2D,i="textureTarget"in g?g.textureTarget=n.get(g.textureTarget):q,d=q==n.TEXTURE_CUBE_MAP,k=t in this.textures,e=k?this.textures[t]:n.createTexture(),p=g.pixelStore,c=g.parameters,h=g.data,o=h.value,l=h.type,s=h.format,u=!!h.value;k||(this.textures[t]=e),n.bindTexture(q,e),k||p.forEach(function(f){f.name=typeof f.name=="string"?n.get(f.name):f.name,n.pixelStorei(f.name,f.value)});if(u)if(d)for(var a=0;a<6;++a)(h.width||h.height)&&(!o.width&&!o.height)?n.texImage2D(i[a],0,s,h.width,h.height,h.border,s,l,o[a]):n.texImage2D(i[a],0,s,s,l,o[a]);else(h.width||h.height)&&(!o.width&&!o.height)?n.texImage2D(i,0,s,h.width,h.height,h.border,s,l,o):n.texImage2D(i,0,s,s,l,o);else(h.width||h.height)&&n.texImage2D(i,0,s,h.width,h.height,h.border,s,l,null);if(!k)for(a=0;a<c.length;a++){var b=c[a];b.name=n.get(b.name),b.value=n.get(b.value),n.texParameteri(q,b.name,b.value),b.generateMipmap&&n.generateMipmap(q)}return g.isCube=d,u&&(g.data.value=!1),this.textureMemo[t]=g,this},setTextures:function(t){for(var g in t)this.setTexture(g,t[g]);return this},use:function(t){return n.useProgram(t.program),this.usedProgram=t,this}},y.Application=B,function(){try{var t=document.createElement("canvas");PhiloGL.hasWebGL=function(){return!!(window.WebGLRenderingContext&&(t.getContext("webgl")||t.getContext("experimental-webgl")))}}catch(g){PhiloGL.hasWebGL=function(){return!1}}PhiloGL.hasExtension=function(g){if(!PhiloGL.hasWebGL())return!1;var q=document.createElement("canvas");return(q.getContext("webgl")||q.getContext("experimental-webgl")).getExtension(g)}}(),PhiloGL.WebGL=y}(),function(){var y=Math.sqrt,B=Math.sin,t=Math.cos,g=Math.tan,q=Math.PI,i=Array.prototype.slice,d=this.Float32Array,k=function(){if(!d||!d.call)return Array;try{d.call({},10)}catch(a){return Array}return d}(),e=k!=Array;function p(a){return{get:function(){return this[a]},set:function(b){this[a]=b},configurable:!1,enumerable:!1}}var c=function(a,b,f){e?(d.call(this,3),this[0]=a||0,this[1]=b||0,this[2]=f||0):this.push(a||0,b||0,f||0),this.typedContainer=new d(3)};c.create=function(){return new d(3)},c.prototype=Object.create(k.prototype,{$$family:{value:"Vec3"},x:p(0),y:p(1),z:p(2)});var h={setVec3:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a},set:function(a,b,f,j){return a[0]=b,a[1]=f,a[2]=j,a},add:function(a,b){return new c(a[0]+b[0],a[1]+b[1],a[2]+b[2])},$add:function(a,b){return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a},add2:function(a,b,f){return a[0]=b[0]+f[0],a[1]=b[1]+f[1],a[2]=b[2]+f[2],a},sub:function(a,b){return new c(a[0]-b[0],a[1]-b[1],a[2]-b[2])},$sub:function(a,b){return a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a},sub2:function(a,b,f){return a[0]=b[0]-f[0],a[1]=b[1]-f[1],a[2]=b[2]-f[2],a},scale:function(a,b){return new c(a[0]*b,a[1]*b,a[2]*b)},$scale:function(a,b){return a[0]*=b,a[1]*=b,a[2]*=b,a},neg:function(a){return new c(-a[0],-a[1],-a[2])},$neg:function(a){return a[0]=-a[0],a[1]=-a[1],a[2]=-a[2],a},unit:function(a){var b=c.norm(a);return b>0?c.scale(a,1/b):c.clone(a)},$unit:function(a){var b=c.norm(a);return b>0?c.$scale(a,1/b):a},cross:function(a,b){var f=a[0],j=a[1],m=a[2],r=b[0],w=b[1],z=b[2];return new c(j*z-m*w,m*r-f*z,f*w-j*r)},$cross:function(a,b){var f=a[0],j=a[1],m=a[2],r=b[0],w=b[1],z=b[2];return a[0]=j*z-m*w,a[1]=m*r-f*z,a[2]=f*w-j*r,a},distTo:function(a,b){var f=a[0]-b[0],j=a[1]-b[1],m=a[2]-b[2];return y(f*f+j*j+m*m)},distToSq:function(a,b){var f=a[0]-b[0],j=a[1]-b[1],m=a[2]-b[2];return f*f+j*j+m*m},norm:function(a){var b=a[0],f=a[1],j=a[2];return y(b*b+f*f+j*j)},normSq:function(a){var b=a[0],f=a[1],j=a[2];return b*b+f*f+j*j},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},clone:function(a){return a.$$family?new c(a[0],a[1],a[2]):c.setVec3(new d(3),a)},toFloat32Array:function(a){var b=a.typedContainer;return b?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b):a}},o=c.prototype;for(var l in h)c[l]=h[l],o[l]=function(a){return function(){var b=i.call(arguments);return b.unshift(this),c[a].apply(c,b)}}(l);var s=function(a,b,f,j,m,r,w,z,v,A,C,F,I,D,H,J){k.call(this,16),this.length=16,typeof a=="number"?this.set(a,b,f,j,m,r,w,z,v,A,C,F,I,D,H,J):this.id(),this.typedContainer=new d(16)};s.create=function(){return new d(16)},s.prototype=Object.create(k.prototype,{$$family:{value:"Mat4"},n11:p(0),n12:p(4),n13:p(8),n14:p(12),n21:p(1),n22:p(5),n23:p(9),n24:p(13),n31:p(2),n32:p(6),n33:p(10),n34:p(14),n41:p(3),n42:p(7),n43:p(11),n44:p(15)}),h={id:function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},clone:function(a){return a.$$family?new s(a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]):new d(a)},set:function(a,b,f,j,m,r,w,z,v,A,C,F,I,D,H,J,P){return a[0]=b,a[4]=f,a[8]=j,a[12]=m,a[1]=r,a[5]=w,a[9]=z,a[13]=v,a[2]=A,a[6]=C,a[10]=F,a[14]=I,a[3]=D,a[7]=H,a[11]=J,a[15]=P,a},mulVec3:function(a,b){var f=c.clone(b);return s.$mulVec3(a,f)},$mulVec3:function(a,b){var f=b[0],j=b[1],m=b[2],r=1/(a[3]*f+a[7]*j+a[11]*m+a[15]);return b[0]=(a[0]*f+a[4]*j+a[8]*m+a[12])*r,b[1]=(a[1]*f+a[5]*j+a[9]*m+a[13])*r,b[2]=(a[2]*f+a[6]*j+a[10]*m+a[14])*r,b},mulMat42:function(a,b,f){var j=b[0],m=b[1],r=b[2],w=b[3],z=b[4],v=b[5],A=b[6],C=b[7],F=b[8],I=b[9],D=b[10],H=b[11],J=b[12],P=b[13],V=b[14],L=b[15],K=f[0],E=f[1],M=f[2],Q=f[3],R=f[4],G=f[5],O=f[6],T=f[7],N=f[8],W=f[9],S=f[10],X=f[11],Y=f[12],Z=f[13],_=f[14],ba=f[15];return a[0]=K*j+E*z+M*F+Q*J,a[1]=K*m+E*v+M*I+Q*P,a[2]=K*r+E*A+M*D+Q*V,a[3]=K*w+E*C+M*H+Q*L,a[4]=R*j+G*z+O*F+T*J,a[5]=R*m+G*v+O*I+T*P,a[6]=R*r+G*A+O*D+T*V,a[7]=R*w+G*C+O*H+T*L,a[8]=N*j+W*z+S*F+X*J,a[9]=N*m+W*v+S*I+X*P,a[10]=N*r+W*A+S*D+X*V,a[11]=N*w+W*C+S*H+X*L,a[12]=Y*j+Z*z+_*F+ba*J,a[13]=Y*m+Z*v+_*I+ba*P,a[14]=Y*r+Z*A+_*D+ba*V,a[15]=Y*w+Z*C+_*H+ba*L,a},mulMat4:function(a,b){var f=s.clone(a);return s.mulMat42(f,a,b)},$mulMat4:function(a,b){return s.mulMat42(a,a,b)},add:function(a,b){var f=s.clone(a);return s.$add(f,b)},$add:function(a,b){return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a[3]+=b[3],a[4]+=b[4],a[5]+=b[5],a[6]+=b[6],a[7]+=b[7],a[8]+=b[8],a[9]+=b[9],a[10]+=b[10],a[11]+=b[11],a[12]+=b[12],a[13]+=b[13],a[14]+=b[14],a[15]+=b[15],a},transpose:function(a){var b=s.clone(a);return s.$transpose(b)},$transpose:function(a){var b=a[4],f=a[8],j=a[12],m=a[1],r=a[9],w=a[13],z=a[2],v=a[6],A=a[14],C=a[3],F=a[7],I=a[11];return a[1]=b,a[2]=f,a[3]=j,a[4]=m,a[6]=r,a[7]=w,a[8]=z,a[9]=v,a[11]=A,a[12]=C,a[13]=F,a[14]=I,a},rotateAxis:function(a,b,f){var j=s.clone(a);return s.$rotateAxis(j,b,f)},$rotateAxis:function(a,b,f){var j=B(b),m=t(b),r=1-m,w=f[0],z=f[1],v=f[2],A=w*w*r+m,C=w*z*r+v*j,F=w*v*r-z*j,I=z*w*r-v*j,D=z*z*r+m,H=z*v*r+w*j,J=w*v*r+z*j,P=z*v*r-w*j,V=v*v*r+m,L=a[0],K=a[1],E=a[2],M=a[3],Q=a[4],R=a[5],G=a[6],O=a[7],T=a[8],N=a[9],W=a[10],S=a[11],X=a[12],Y=a[13],Z=a[14],_=a[15];return a[0]=L*A+Q*C+T*F,a[1]=K*A+R*C+N*F,a[2]=E*A+G*C+W*F,a[3]=M*A+O*C+S*F,a[4]=L*I+Q*D+T*H,a[5]=K*I+R*D+N*H,a[6]=E*I+G*D+W*H,a[7]=M*I+O*D+S*H,a[8]=L*J+Q*P+T*V,a[9]=K*J+R*P+N*V,a[10]=E*J+G*P+W*V,a[11]=M*J+O*P+S*V,a},rotateXYZ:function(a,b,f,j){var m=s.clone(a);return s.$rotateXYZ(m,b,f,j)},$rotateXYZ:function(a,b,f,j){var m=a[0],r=a[1],w=a[2],z=a[3],v=a[4],A=a[5],C=a[6],F=a[7],I=a[8],D=a[9],H=a[10],J=a[11],P=t(b),V=t(f),L=t(j),K=B(b),E=B(f),M=B(j),Q=V*L,R=-P*M+K*E*L,G=K*M+P*E*L,O=V*M,T=P*L+K*E*M,N=-K*L+P*E*M,W=-E,S=K*V,X=P*V;return a[0]=m*Q+v*O+I*W,a[1]=r*Q+A*O+D*W,a[2]=w*Q+C*O+H*W,a[3]=z*Q+F*O+J*W,a[4]=m*R+v*T+I*S,a[5]=r*R+A*T+D*S,a[6]=w*R+C*T+H*S,a[7]=z*R+F*T+J*S,a[8]=m*G+v*N+I*X,a[9]=r*G+A*N+D*X,a[10]=w*G+C*N+H*X,a[11]=z*G+F*N+J*X,a},translate:function(a,b,f,j){var m=s.clone(a);return s.$translate(m,b,f,j)},$translate:function(a,b,f,j){return a[12]=a[0]*b+a[4]*f+a[8]*j+a[12],a[13]=a[1]*b+a[5]*f+a[9]*j+a[13],a[14]=a[2]*b+a[6]*f+a[10]*j+a[14],a[15]=a[3]*b+a[7]*f+a[11]*j+a[15],a},scale:function(a,b,f,j){var m=s.clone(a);return s.$scale(m,b,f,j)},$scale:function(a,b,f,j){return a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,a[4]*=f,a[5]*=f,a[6]*=f,a[7]*=f,a[8]*=j,a[9]*=j,a[10]*=j,a[11]*=j,a},invert:function(a){var b=s.clone(a);return s.$invert(b)},$invert:function(a){var b=a[0],f=a[1],j=a[2],m=a[3],r=a[4],w=a[5],z=a[6],v=a[7],A=a[8],C=a[9],F=a[10],I=a[11],D=a[12],H=a[13],J=a[14],P=a[15],V=b*w-f*r,L=b*z-j*r,K=b*v-m*r,E=f*z-j*w,M=f*v-m*w,Q=j*v-m*z,R=A*H-C*D,G=A*J-F*D,O=A*P-I*D,T=C*J-F*H,N=C*P-I*H,W=F*P-I*J,S=1/(V*W-L*N+K*T+E*O-M*G+Q*R);return a[0]=(+w*W-z*N+v*T)*S,a[1]=(-f*W+j*N-m*T)*S,a[2]=(+H*Q-J*M+P*E)*S,a[3]=(-C*Q+F*M-I*E)*S,a[4]=(-r*W+z*O-v*G)*S,a[5]=(+b*W-j*O+m*G)*S,a[6]=(-D*Q+J*K-P*L)*S,a[7]=(+A*Q-F*K+I*L)*S,a[8]=(+r*N-w*O+v*R)*S,a[9]=(-b*N+f*O-m*R)*S,a[10]=(+D*M-H*K+P*V)*S,a[11]=(-A*M+C*K-I*V)*S,a[12]=(-r*T+w*G-z*R)*S,a[13]=(+b*T-f*G+j*R)*S,a[14]=(-D*E+H*L-J*V)*S,a[15]=(+A*E-C*L+F*V)*S,a},lookAt:function(a,b,f,j){var m=c.sub(b,f);m.$unit();var r=c.cross(j,m);r.$unit();var w=c.cross(m,r);return w.$unit(),s.set(a,r[0],r[1],r[2],-r.dot(b),w[0],w[1],w[2],-w.dot(b),m[0],m[1],m[2],-m.dot(b),0,0,0,1)},frustum:function(a,b,f,j,m,r,w){var z=f-b,v=m-j,A=w-r;return a[0]=r*2/z,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=r*2/v,a[6]=0,a[7]=0,a[8]=(f+b)/z,a[9]=(m+j)/v,a[10]=-(w+r)/A,a[11]=-1,a[12]=0,a[13]=0,a[14]=-(w*r*2)/A,a[15]=0,a},perspective:function(a,b,f,j,m){var r=j*g(b*q/360),w=-r,z=w*f,v=r*f;return s.frustum(a,z,v,w,r,j,m)},ortho:function(a,b,f,j,m,r,w){var z=this.elements,v=f-b,A=j-m,C=w-r,F=(f+b)/v,I=(j+m)/A,D=(w+r)/C;return a[0]=2/v,a[4]=0,a[8]=0,a[12]=-F,a[1]=0,a[5]=2/A,a[9]=0,a[13]=-I,a[2]=0,a[6]=0,a[10]=-2/C,a[14]=-D,a[3]=0,a[7]=0,a[11]=0,a[15]=1,a},toFloat32Array:function(a){var b=a.typedContainer;return b?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b):a}},o=s.prototype;for(l in h)s[l]=h[l],o[l]=function(a){return function(){var b=i.call(arguments);return b.unshift(this),s[a].apply(s,b)}}(l);var u=function(a,b,f,j){k.call(this,4),this[0]=a||0,this[1]=b||0,this[2]=f||0,this[3]=j||0,this.typedContainer=new d(4)};u.create=function(){return new d(4)},h={setQuat:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},set:function(a,b,f,j,m){return a[0]=b||0,a[1]=f||0,a[2]=j||0,a[3]=m||0,a},clone:function(a){return a.$$family?new u(a[0],a[1],a[2],a[3]):u.setQuat(new d(4),a)},neg:function(a){return new u(-a[0],-a[1],-a[2],-a[3])},$neg:function(a){return a[0]=-a[0],a[1]=-a[1],a[2]=-a[2],a[3]=-a[3],a},add:function(a,b){return new u(a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3])},$add:function(a,b){return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a[3]+=b[3],a},sub:function(a,b){return new u(a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3])},$sub:function(a,b){return a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a[3]-=b[3],a},scale:function(a,b){return new u(a[0]*b,a[1]*b,a[2]*b,a[3]*b)},$scale:function(a,b){return a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,a},mulQuat:function(a,b){var f=a[0],j=a[1],m=a[2],r=a[3],w=b[0],z=b[1],v=b[2],A=b[3];return new u(r*w+f*A+j*v-m*z,r*z+j*A+m*w-f*v,r*v+m*A+f*z-j*w,r*A-f*w-j*z-m*v)},$mulQuat:function(a,b){var f=a[0],j=a[1],m=a[2],r=a[3],w=b[0],z=b[1],v=b[2],A=b[3];return a[0]=r*w+f*A+j*v-m*z,a[1]=r*z+j*A+m*w-f*v,a[2]=r*v+m*A+f*z-j*w,a[3]=r*A-f*w-j*z-m*v,a},divQuat:function(a,b){var f=a[0],j=a[1],m=a[2],r=a[3],w=b[0],z=b[1],v=b[2],A=b[3],C=1/(A*A+w*w+z*z+v*v);return new u((f*A-r*w-j*v+m*z)*C,(f*v-r*z+j*A-m*w)*C,(j*w+m*A-r*v-f*z)*C,(r*A+f*w+j*z+m*v)*C)},$divQuat:function(a,b){var f=a[0],j=a[1],m=a[2],r=a[3],w=b[0],z=b[1],v=b[2],A=b[3],C=1/(A*A+w*w+z*z+v*v);return a[0]=(f*A-r*w-j*v+m*z)*C,a[1]=(f*v-r*z+j*A-m*w)*C,a[2]=(j*w+m*A-r*v-f*z)*C,a[3]=(r*A+f*w+j*z+m*v)*C,a},invert:function(a){var b=a[0],f=a[1],j=a[2],m=a[3],r=1/(b*b+f*f+j*j+m*m);return new u(-b*r,-f*r,-j*r,m*r)},$invert:function(a){var b=a[0],f=a[1],j=a[2],m=a[3],r=1/(b*b+f*f+j*j+m*m);return a[0]=-b*r,a[1]=-f*r,a[2]=-j*r,a[3]=m*r,a},norm:function(a){var b=a[0],f=a[1],j=a[2],m=a[3];return y(b*b+f*f+j*j+m*m)},normSq:function(a){var b=a[0],f=a[1],j=a[2],m=a[3];return b*b+f*f+j*j+m*m},unit:function(a){return u.scale(a,1/u.norm(a))},$unit:function(a){return u.$scale(a,1/u.norm(a))},conjugate:function(a){return new u(-a[0],-a[1],-a[2],a[3])},$conjugate:function(a){return a[0]=-a[0],a[1]=-a[1],a[2]=-a[2],a}},o=u.prototype={};for(l in h)u[l]=h[l],o[l]=function(a){return function(){var b=i.call(arguments);return b.unshift(this),u[a].apply(u,b)}}(l);c.fromQuat=function(a){return new c(a[0],a[1],a[2])},u.fromVec3=function(a,b){return new u(a[0],a[1],a[2],b||0)},u.fromMat4=function(a){var b,f,j;a[0]>a[5]&&a[0]>a[10]?(b=0,f=1,j=2):a[5]>a[0]&&a[5]>a[10]?(b=1,f=2,j=0):(b=2,f=0,j=1);var m=y(1+a[b*5]-a[f*5]-a[j*5]),r=new u();return r[b]=.5*m,r[f]=.5*(a["n"+f+""+b]+a["n"+b+""+f])/m,r[j]=.5*(a["n"+b+""+j]+a["n"+j+""+b])/m,r[3]=.5*(a["n"+f+""+j]-a["n"+j+""+f])/m,r},u.fromXRotation=function(a){return new u(B(a/2),0,0,t(a/2))},u.fromYRotation=function(a){return new u(0,B(a/2),0,t(a/2))},u.fromZRotation=function(a){return new u(0,0,B(a/2),t(a/2))},u.fromAxisRotation=function(a,b){var f=a[0],j=a[1],m=a[2],r=1/y(f*f+j*j+m*m),w=B(b/2),z=t(b/2);return new u(w*f*r,w*j*r,w*m*r,z)},s.fromQuat=function(a){var b=a[3],f=a[0],j=a[1],m=a[2];return new s(b*b+f*f-j*j-m*m,2*f*j-2*b*m,2*f*m+2*b*j,0,2*f*j+2*b*m,b*b-f*f+j*j-m*m,2*j*m-2*b*f,0,2*f*m-2*b*j,2*j*m+2*b*f,b*b-f*f-j*j+m*m,0,0,0,0,1)},PhiloGL.Vec3=c,PhiloGL.Mat4=s,PhiloGL.Quat=u}(),function(){function y(d){return d!==!0?d:!1}var B=function(d){var k=d.getBoundingClientRect();return{x:k.left,y:k.top,bbox:k}},t={get:function(d,k){return k=k||window,d||k.event},getWheel:function(d){return d.wheelDelta?d.wheelDelta/120:-(d.detail||0)/3},getKey:function(d){var k=d.which||d.keyCode,e=i(k),p=k-111;return p>0&&p<13&&(e="f"+p),e=e||String.fromCharCode(k).toLowerCase(),{code:k,key:e,shift:d.shiftKey,control:d.ctrlKey,alt:d.altKey,meta:d.metaKey}},isRightClick:function(d){return d.which==3||d.button==2},getPos:function(d,k){k=k||window,d=d||k.event;var e=k.document,p;e=e.documentElement||e.body;if(d.touches&&d.touches.length){p=[];for(var c=0,h=d.touches.length,o;c<h;++c)o=d.touches[c],p.push({x:o.pageX||o.clientX+e.scrollLeft,y:o.pageY||o.clientY+e.scrollTop});return p}var l={x:d.pageX||d.clientX+e.scrollLeft,y:d.pageY||d.clientY+e.scrollTop};return[l]},stop:function(d){d.stopPropagation&&d.stopPropagation(),d.cancelBubble=!0,d.preventDefault?d.preventDefault():d.returnValue=!1}},g=function(d,k){var e=d.canvas;this.scene=d.scene,this.domElem=e,this.pos=B(e),this.opt=this.callbacks=k,this.size={width:e.width||e.offsetWidth,height:e.height||e.offsetHeight},this.attachEvents()};g.prototype={hovered:!1,pressed:!1,touched:!1,touchedLastPosition:{x:0,y:0},touchMoved:!1,moved:!1,attachEvents:function(){var d=this.domElem,k=this.opt,e=this;k.disableContextMenu&&(d.oncontextmenu=function(){return!1});if(k.enableMouse){["mouseup","mousedown","mousemove","mouseover","mouseout"].forEach(function(c){d.addEventListener(c,function(h,o){e[c](e.eventInfo(c,h,o))},!1)});var p="";!document.getBoxObjectFor&&window.mozInnerScreenX==null?p="mousewheel":p="DOMMouseScroll",d.addEventListener(p,function(c,h){e.mousewheel(e.eventInfo("mousewheel",c,h))},!1)}k.enableTouch&&["touchstart","touchmove","touchend"].forEach(function(c){d.addEventListener(c,function(h,o){e[c](e.eventInfo(c,h,o))},!1)}),k.enableKeyboard&&["keydown","keyup"].forEach(function(c){document.addEventListener(c,function(h,o){e[c](e.eventInfo(c,h,o))},!1)})},eventInfo:function(d,k,e){for(var p=this.domElem,c=this.scene,h=this.opt,o=this.getSize(),l=h.relative,s=h.centerOrigin,u=h.cachePosition&&this.pos||B(p),a=t.get(k,e),b=t.getPos(k,e),f={x:b[0].x,y:b[0].y},j={},m,r,w=0,z=b.length;w<z;++w)m=b[w].x,r=b[w].y,l&&(m-=u.x,r-=u.y,s&&(m-=o.width/2,r-=o.height/2,r*=-1)),b[w].x=m,b[w].y=r;switch(d){case"mousewheel":j.wheel=t.getWheel(a);break;case"keydown":case"keyup":x.extend(j,t.getKey(a));break;case"mouseup":j.isRightClick=t.isRightClick(a);break}var v;return x.extend(j,{x:b[0].x,y:b[0].y,posArray:b,cache:!1,stop:function(){t.stop(a)},getTarget:function(){return v?v:v=h.picking&&c.pick(f.x-u.x,f.y-u.y)||!1}}),j.event=a,j},getSize:function(){if(this.cacheSize)return this.size;var d=this.domElem;return{width:d.width||d.offsetWidth,height:d.height||d.offsetHeight}},mouseup:function(d){this.moved||(d.isRightClick?this.callbacks.onRightClick(d,this.hovered):this.callbacks.onClick(d,y(this.pressed))),this.pressed&&(this.moved?this.callbacks.onDragEnd(d,y(this.pressed)):this.callbacks.onDragCancel(d,y(this.pressed)),this.pressed=this.moved=!1)},mouseout:function(d){for(var k=d.relatedTarget,e=this.domElem;k&&k.parentNode;){if(e==k.parentNode)return;k=k.parentNode}this.hovered&&(this.callbacks.onMouseLeave(d,this.hovered),this.hovered=!1),this.pressed&&this.moved&&(this.callbacks.onDragEnd(d),this.pressed=this.moved=!1)},mouseover:function(d){},mousemove:function(d){if(this.pressed){this.moved=!0,this.callbacks.onDragMove(d,y(this.pressed));return}if(this.hovered){var k=y(d.getTarget());!k||k.hash!=this.hash?(this.callbacks.onMouseLeave(d,this.hovered),this.hovered=k,this.hash=k,k&&(this.hash=k.hash,this.callbacks.onMouseEnter(d,this.hovered))):this.callbacks.onMouseMove(d,this.hovered)}else this.hovered=y(d.getTarget()),this.hash=this.hovered,this.hovered&&(this.hash=this.hovered.hash,this.callbacks.onMouseEnter(d,this.hovered));this.opt.picking||this.callbacks.onMouseMove(d)},mousewheel:function(d){this.callbacks.onMouseWheel(d)},mousedown:function(d){this.pressed=d.getTarget(),this.callbacks.onDragStart(d,y(this.pressed))},touchstart:function(d){this.touched=d.getTarget(),this.touchedLastPosition={x:d.x,y:d.y},this.callbacks.onTouchStart(d,y(this.touched))},touchmove:function(d){this.touched&&(this.touchMoved=!0,this.callbacks.onTouchMove(d,y(this.touched)))},touchend:function(d){this.touched&&(this.touchMoved?this.callbacks.onTouchEnd(d,y(this.touched)):(d.x=isNaN(d.x)?this.touchedLastPosition.x:d.x,d.y=isNaN(d.y)?this.touchedLastPosition.y:d.y,this.callbacks.onTap(d,y(this.touched)),this.callbacks.onTouchCancel(d,y(this.touched))),this.touched=this.touchMoved=!1)},keydown:function(d){this.callbacks.onKeyDown(d)},keyup:function(d){this.callbacks.onKeyUp(d)}};var q={};q.create=function(d,k){k=x.extend({cachePosition:!0,cacheSize:!0,relative:!0,centerOrigin:!0,disableContextMenu:!0,bind:!1,picking:!1,lazyPicking:!1,enableTouch:!0,enableMouse:!0,enableKeyboard:!0,onClick:x.empty,onRightClick:x.empty,onDragStart:x.empty,onDragMove:x.empty,onDragEnd:x.empty,onDragCancel:x.empty,onTouchStart:x.empty,onTouchMove:x.empty,onTouchEnd:x.empty,onTouchCancel:x.empty,onTap:x.empty,onMouseMove:x.empty,onMouseEnter:x.empty,onMouseLeave:x.empty,onMouseWheel:x.empty,onKeyDown:x.empty,onKeyUp:x.empty},k||{});var e=k.bind;if(e)for(var p in k)p.match(/^on[a-zA-Z0-9]+$/)&&function(c,h){k[c]=function(){return h.apply(e,Array.prototype.slice.call(arguments))}}(p,k[p]);new g(d,k),d.events=k},q.Keys={enter:13,up:38,down:40,left:37,right:39,esc:27,space:32,backspace:8,tab:9,delete:46};function i(d){var k=q.Keys;for(var e in k)if(k[e]==d)return e}PhiloGL.Events=q}(),function(){var y=function(e,p,c){var h=e.createShader(c);if(h==null)throw"Error creating the shader with shader type: "+c;e.shaderSource(h,p),e.compileShader(h);var o=e.getShaderParameter(h,e.COMPILE_STATUS);if(!o){var l=e.getShaderInfoLog(h);throw e.deleteShader(h),"Error while compiling the shader "+l}return h},B=function(e,p,c){var h=e.createProgram();return e.attachShader(h,y(e,p,e.VERTEX_SHADER)),e.attachShader(h,y(e,c,e.FRAGMENT_SHADER)),q(e,h),h},t=function(e){var p=e.lastIndexOf("/");return p=="/"?"./":e.substr(0,p+1)},g=function(e,p,c,h,o){o=o||{};var l;if(l=p.match(/#include "(.*?)"/)){var s=PhiloGL.IO.XHR,u=t(e)+l[1];return o[u]&&h("Recursive include"),new s({url:u,noCache:!0,onError:function(a){h("Load included file `"+u+"` failed: Code "+a)},onSuccess:function(a){return o[u]=!0,g(u,a,function(b){return delete o[u],p=p.replace(/#include ".*?"/,b),p=p.replace(/\sHAS_EXTENSION\s*\(\s*([A-Za-z_\-0-9]+)\s*\)/g,function(f,j){return n.getExtension(j)?" 1 ":" 0 "}),g(u,p,c,h,o)},h,o)}}).send(),null}else return c(p)},q=function(e,p){e.linkProgram(p);var c=e.getProgramParameter(p,e.LINK_STATUS);if(!c)throw"Error linking the shader: "+e.getProgramInfoLog(p);return!0},i=function(e,p,c){var h=p.name,o=n.getUniformLocation(e,h),l=p.type,s=!1,u=!0,a,b;if(p.size>1&&c)switch(l){case n.FLOAT:a=n.uniform1fv,b=Float32Array,u=!1;break;case n.INT:case n.BOOL:case n.SAMPLER_2D:case n.SAMPLER_CUBE:a=n.uniform1iv,b=Uint16Array,u=!1;break}if(u)switch(l){case n.FLOAT:a=n.uniform1f;break;case n.FLOAT_VEC2:a=n.uniform2fv,b=c?Float32Array:new Float32Array(2);break;case n.FLOAT_VEC3:a=n.uniform3fv,b=c?Float32Array:new Float32Array(3);break;case n.FLOAT_VEC4:a=n.uniform4fv,b=c?Float32Array:new Float32Array(4);break;case n.INT:case n.BOOL:case n.SAMPLER_2D:case n.SAMPLER_CUBE:a=n.uniform1i;break;case n.INT_VEC2:case n.BOOL_VEC2:a=n.uniform2iv,b=c?Uint16Array:new Uint16Array(2);break;case n.INT_VEC3:case n.BOOL_VEC3:a=n.uniform3iv,b=c?Uint16Array:new Uint16Array(3);break;case n.INT_VEC4:case n.BOOL_VEC4:a=n.uniform4iv,b=c?Uint16Array:new Uint16Array(4);break;case n.FLOAT_MAT2:s=!0,a=n.uniformMatrix2fv;break;case n.FLOAT_MAT3:s=!0,a=n.uniformMatrix3fv;break;case n.FLOAT_MAT4:s=!0,a=n.uniformMatrix4fv;break}a=a.bind(n);if(c&&b)return function(f){a(o,new b(f))};return s?function(f){a(o,!1,f.toFloat32Array())}:b?function(f){b.set(f.toFloat32Array?f.toFloat32Array():f),a(o,b)}:function(f){a(o,f)};throw"Unknown type: "+l},d=function(e,p){var c=B(n,e,p);if(!c)return!1;for(var h={},o={},l={},s,u,a,b=n.getProgramParameter(c,n.ACTIVE_ATTRIBUTES),f=0;f<b;f++)s=n.getActiveAttrib(c,f),u=s.name,a=n.getAttribLocation(c,s.name),h[u]=a;for(b=n.getProgramParameter(c,n.ACTIVE_UNIFORMS),f=0;f<b;f++)s=n.getActiveUniform(c,f),u=s.name,u=u[u.length-1]=="]"?u.substr(0,u.length-3):u,l[u]=i(c,s,s.name!=u);this.program=c,this.attributes=h,this.attributeEnabled=o,this.uniforms=l};d.prototype={$$family:"program",setUniform:function(e,p){return this.uniforms[e]&&this.uniforms[e](p),this},setUniforms:function(e){for(var p in e)this.setUniform(p,e[p]);return this}},["setBuffer","setBuffers","use"].forEach(function(e){d.prototype[e]=function(){var p=Array.prototype.slice.call(arguments);return p.unshift(this),U[e].apply(U,p),this}}),["setFrameBuffer","setFrameBuffers","setRenderBuffer","setRenderBuffers","setTexture","setTextures"].forEach(function(e){d.prototype[e]=function(){return U[e].apply(U,arguments),this}});function k(e,p){var c;return e.length==2?c={vs:e[0],fs:e[1]}:c=e[0]||{},x.merge(p||{},c)}d.fromShaderIds=function(){var e=k(arguments),p=x(e.vs),c=x(e.fs);return g(e.path,p.innerHTML,function(h){return g(e.path,c.innerHTML,function(o){e.onSuccess(new d(h,o),e)})})},d.fromShaderSources=function(){var e=k(arguments,{path:"./"});return g(e.path,e.vs,function(p){return g(e.path,e.fs,function(c){try{var h=new d(p,c);if(e.onSuccess)e.onSuccess(h,e);else return h}catch(o){if(e.onError)e.onError(o,e);else throw o}})})},d.fromDefaultShaders=function(e){e=e||{};var p=e.vs||"Default",c=e.fs||"Default",h=PhiloGL.Shaders;return e.vs=h.Vertex[p],e.fs=h.Fragment[c],PhiloGL.Program.fromShaderSources(e)},d.fromShaderURIs=function(e){e=x.merge({path:"",vs:"",fs:"",noCache:!1,onSuccess:x.empty,onError:x.empty},e||{});var p=e.path+e.vs,c=e.path+e.fs,h=PhiloGL.IO.XHR;new h.Group({urls:[p,c],noCache:e.noCache,onError:function(o){e.onError(o)},onComplete:function(o){try{return g(p,o[0],function(l){return g(c,o[1],function(s){return e.vs=l,e.fs=s,d.fromShaderSources(e)},e.onError)},e.onError)}catch(l){e.onError(l,e)}}}).send()},PhiloGL.Program=d}(),function(){var y={},B=function(i){i=x.merge({url:"http://philogljs.org/",method:"GET",async:!0,noCache:!1,sendAsBinary:!1,responseType:!1,onProgress:x.empty,onSuccess:x.empty,onError:x.empty,onAbort:x.empty,onComplete:x.empty},i||{}),this.opt=i,this.initXHR()};B.State={},["UNINITIALIZED","LOADING","LOADED","INTERACTIVE","COMPLETED"].forEach(function(i,d){B.State[i]=d}),B.prototype={initXHR:function(){var i=this.req=new XMLHttpRequest(),d=this;["Progress","Error","Abort","Load"].forEach(function(k){i.addEventListener?i.addEventListener(k.toLowerCase(),function(e){d["handle"+k](e)},!1):i["on"+k.toLowerCase()]=function(e){d["handle"+k](e)}})},send:function(i){var d=this.req,k=this.opt,e=k.async;k.noCache&&(k.url+=(k.url.indexOf("?")>=0?"&":"?")+x.uid()),d.open(k.method,k.url,e),k.responseType&&(d.responseType=k.responseType),e&&(d.onreadystatechange=function(p){d.readyState==B.State.COMPLETED&&(d.status==200?k.onSuccess(d.responseType?d.response:d.responseText):k.onError(d.status))}),k.sendAsBinary?d.sendAsBinary(i||k.body||null):d.send(i||k.body||null),e||(d.status==200?k.onSuccess(d.responseType?d.response:d.responseText):k.onError(d.status))},setRequestHeader:function(i,d){return this.req.setRequestHeader(i,d),this},handleProgress:function(i){i.lengthComputable?this.opt.onProgress(i,Math.round(i.loaded/i.total*100)):this.opt.onProgress(i,-1)},handleError:function(i){this.opt.onError(i)},handleAbort:function(i){this.opt.onAbort(i)},handleLoad:function(i){this.opt.onComplete(i)}},B.Group=function(i){i=x.merge({urls:[],onError:x.empty,onSuccess:x.empty,onComplete:x.empty,method:"GET",async:!0,noCache:!1,sendAsBinary:!1,responseType:!1},i||{});var d=x.splat(i.urls),k=d.length,e=new Array(k),p=d.map(function(o,l){return new B({url:o,method:i.method,async:i.async,noCache:i.noCache,sendAsBinary:i.sendAsBinary,responseType:i.responseType,body:i.body,onError:c(l),onSuccess:h(l)})});function c(o){return function(l){--k,i.onError(l,o),k||i.onComplete(e)}}function h(o){return function(l){--k,e[o]=l,i.onSuccess(l,o),k||i.onComplete(e)}}this.reqs=p},B.Group.prototype={send:function(){for(var i=0,d=this.reqs,k=d.length;i<k;++i)d[i].send()}};var t=function(i){i=x.merge({url:"http://philogljs.org/",data:{},noCache:!1,onComplete:x.empty,callbackKey:"callback"},i||{});var d=t.counter++,k=[];for(var e in i.data)k.push(e+"="+i.data[e]);k=k.join("&"),i.noCache&&(k+=(k.indexOf("?")>=0?"&":"?")+x.uid());var p=i.url+(i.url.indexOf("?")>-1?"&":"?")+i.callbackKey+"=PhiloGL.IO.JSONP.requests.request_"+d+(k.length>0?"&"+k:""),c=document.createElement("script");c.type="text/javascript",c.src=p,t.requests["request_"+d]=function(h){i.onComplete(h),c.parentNode&&c.parentNode.removeChild(c),c.clearAttributes&&c.clearAttributes()},document.getElementsByTagName("head")[0].appendChild(c)};t.counter=0,t.requests={};var g=function(i){i=x.merge({src:[],noCache:!1,onProgress:x.empty,onComplete:x.empty},i||{});var d=0,k=i.src.length,e=function(){i.onProgress(Math.round(++d/k*100)),d==k&&i.onComplete(l)},p=function(){++d==k&&i.onComplete(l)},c=i.noCache,h=x.uid(),o=function(s){return(s.indexOf("?")>=0?"&":"?")+h},l=i.src.map(function(s,u){var a=new Image();return a.index=u,a.onload=e,a.onerror=p,a.src=s+(c?o(s):""),a});return l},q=function(i){i=x.merge({src:[],noCache:!1,onComplete:x.empty},i||{}),g({src:i.src,noCache:i.noCache,onComplete:function(d){var k={};d.forEach(function(e,p){k[i.id&&i.id[p]||i.src&&i.src[p]]=x.merge({data:{value:e}},i)}),U.setTextures(k),i.onComplete()}})};y.XHR=B,y.JSONP=t,y.Images=g,y.Textures=q,PhiloGL.IO=y}(),function(){var y=PhiloGL.Vec3,B=PhiloGL.Mat4,t=function(g,q,i,d,k){k=k||{};var e=k.position,p=k.target,c=k.up;this.type=k.type?k.type:"perspective",this.fov=g,this.near=i,this.far=d,this.aspect=q,this.position=e&&new y(e.x,e.y,e.z)||new y(),this.target=p&&new y(p.x,p.y,p.z)||new y(),this.up=c&&new y(c.x,c.y,c.z)||new y(0,1,0);if(this.type=="perspective")this.projection=new B().perspective(g,q,i,d);else{var h=i*Math.tan(g*Math.PI/360),o=-h,l=o*q,s=h*q;this.projection=new B().ortho(l,s,o,h,i,d)}this.view=new B()};t.prototype={update:function(){if(this.type=="perspective")this.projection=new B().perspective(this.fov,this.aspect,this.near,this.far);else{var g=this.near*Math.tan(this.fov*Math.PI/360),q=-g,i=q*this.aspect,d=g*this.aspect;this.projection=new B().ortho(i,d,q,g,this.near,this.far)}this.view.lookAt(this.position,this.target,this.up)},setStatus:function(g){var q=this,i=q.position,d=q.view,k=q.projection,e=d.mulMat4(k),p=e.invert();g.setUniforms({cameraPosition:[i.x,i.y,i.z],projectionMatrix:k,viewMatrix:d,viewProjectionMatrix:e,viewInverseMatrix:d.invert(),viewProjectionInverseMatrix:p})}},PhiloGL.Camera=t}(),function(){var y=PhiloGL.Vec3,B=PhiloGL.Mat4,t=Math.cos,g=Math.sin,q=Math.PI,i=Math.max,d=Array.prototype.slice;function k(c,h){if(c&&c.length<h){for(var o=c[0],l=c[1],s=c[2],u=c[3],a=[o,l,s,u],b=h/c.length,f;--b;)f=b*4,a[f]=o,a[f+1]=l,a[f+2]=s,a[f+3]=u;return new Float32Array(a)}else return c}var e={attributeMap:{position:"vertices",normal:"normals",pickingColor:"pickingColors",colors:"color"}};e.Model=function(c){c=c||{},this.id=c.id||x.uid(),this.pickable=!!c.pickable,this.pick=c.pick||function(){return!1},this.vertices=c.vertices,this.normals=c.normals,this.textures=c.textures&&x.splat(c.textures),this.colors=c.colors,this.indices=c.indices,this.shininess=c.shininess||0,this.reflection=c.reflection||0,this.refraction=c.refraction||0,c.pickingColors&&(this.pickingColors=c.pickingColors),c.texCoords&&(this.texCoords=c.texCoords),this.uniforms=c.uniforms||{},this.attributes=c.attributes||{},this.render=c.render,this.drawType=c.drawType||"TRIANGLES",this.display="display"in c?c.display:!0,this.onBeforeRender=c.onBeforeRender||x.empty,this.onAfterRender=c.onAfterRender||x.empty,c.program&&(this.program=c.program),this.position=new y(),this.rotation=new y(),this.scale=new y(1,1,1),this.matrix=new B(),c.computeCentroids&&this.computeCentroids(),c.computeNormals&&this.computeNormals()};var p={setUniforms:function(c){c.setUniforms(this.uniforms)},setAttributes:function(c){var h=this.attributes;for(var o in h){var l=h[o],s=this.id+"-"+o;Object.keys(l).length?(l.attribute=o,c.setBuffer(s,l),delete l.value):c.setBuffer(s,!0)}},setVertices:function(c){if(!this.$vertices)return;this.dynamic?c.setBuffer("position-"+this.id,{attribute:"position",value:this.$vertices,size:3}):c.setBuffer("position-"+this.id)},setNormals:function(c){if(!this.$normals)return;this.dynamic?c.setBuffer("normal-"+this.id,{attribute:"normal",value:this.$normals,size:3}):c.setBuffer("normal-"+this.id)},setIndices:function(c){if(!this.$indices)return;this.dynamic?c.setBuffer("indices-"+this.id,{bufferType:n.ELEMENT_ARRAY_BUFFER,drawType:n.STATIC_DRAW,value:this.$indices,size:1}):c.setBuffer("indices-"+this.id)},setPickingColors:function(c){if(!this.$pickingColors)return;this.dynamic?c.setBuffer("pickingColor-"+this.id,{attribute:"pickingColor",value:this.$pickingColors,size:4}):c.setBuffer("pickingColor-"+this.id)},setColors:function(c){if(!this.$colors)return;this.dynamic?c.setBuffer("color-"+this.id,{attribute:"color",value:this.$colors,size:4}):c.setBuffer("color-"+this.id)},setTexCoords:function(c){if(!this.$texCoords)return;var h=this.id,o,l,s,u;if(this.dynamic)if(x.type(this.$texCoords)=="object")for(o=0,l=this.textures,s=l.length;o<s;o++)u=l[o],c.setBuffer("texCoord-"+o+"-"+h,{attribute:"texCoord"+(o+1),value:this.$texCoords[u],size:2});else c.setBuffer("texCoord-"+h,{attribute:"texCoord1",value:this.$texCoords,size:2});else if(x.type(this.$texCoords)=="object")for(o=0,l=this.textures,s=l.length;o<s;o++)c.setBuffer("texCoord-"+o+"-"+h);else c.setBuffer("texCoord-"+h)},setTextures:function(c,h){this.textures=this.textures?x.splat(this.textures):[];for(var o=5,l=0,s=this.textures,u=s.length,a=PhiloGL.Scene.MAX_TEXTURES;l<a;l++){if(l<u){var b=U.textureMemo[s[l]].isCube;b?(c.setUniform("hasTextureCube"+(l+1),!0),c.setTexture(s[l],n["TEXTURE"+(l+o)])):(c.setUniform("hasTexture"+(l+1),!0),c.setTexture(s[l],n["TEXTURE"+l]))}else c.setUniform("hasTextureCube"+(l+1),!1),c.setUniform("hasTexture"+(l+1),!1);c.setUniform("sampler"+(l+1),l),c.setUniform("samplerCube"+(l+1),l+o)}},setState:function(c){this.setUniforms(c),this.setAttributes(c),this.setVertices(c),this.setColors(c),this.setPickingColors(c),this.setNormals(c),this.setTextures(c),this.setTexCoords(c),this.setIndices(c)},unsetState:function(c){var h=c.attributes;n.bindBuffer(n.ARRAY_BUFFER,null),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(var o in h)n.disableVertexAttribArray(h[o])}};e.Model.prototype=Object.create(null,{hash:{get:function(){return this.id+" "+this.$pickingIndex}},vertices:{set:function(c){if(!c){delete this.$vertices,delete this.$verticesLength;return}var h=c.length;c.BYTES_PER_ELEMENT?this.$vertices=c:this.$verticesLength==h?this.$vertices.set(c):this.$vertices=new Float32Array(c),this.$verticesLength=h},get:function(){return this.$vertices}},normals:{set:function(c){if(!c){delete this.$normals,delete this.$normalsLength;return}var h=c.length;c.BYTES_PER_ELEMENT?this.$normals=c:this.$normalsLength==h?this.$normals.set(c):this.$normals=new Float32Array(c),this.$normalsLength=h},get:function(){return this.$normals}},colors:{set:function(c){if(!c){delete this.$colors,delete this.$colorsLength;return}var h=c.length;c.BYTES_PER_ELEMENT?this.$colors=c:this.$colorsLength==h?this.$colors.set(c):this.$colors=new Float32Array(c),this.$vertices&&this.$verticesLength/3*4!=h&&(this.$colors=k(d.call(this.$colors),this.$verticesLength/3*4)),this.$colorsLength=this.$colors.length},get:function(){return this.$colors}},pickingColors:{set:function(c){if(!c){delete this.$pickingColors,delete this.$pickingColorsLength;return}var h=c.length;c.BYTES_PER_ELEMENT?this.$pickingColors=c:this.$pickingColorsLength==h?this.$pickingColors.set(c):this.$pickingColors=new Float32Array(c),this.$vertices&&this.$verticesLength/3*4!=h&&(this.$pickingColors=k(d.call(this.$pickingColors),this.$verticesLength/3*4)),this.$pickingColorsLength=this.$pickingColors.length},get:function(){return this.$pickingColors}},texCoords:{set:function(c){if(!c){delete this.$texCoords,delete this.$texCoordsLength;return}if(x.type(c)=="object"){var h={};for(var o in c){var l=c[o];h[o]=l.BYTES_PER_ELEMENT?l:new Float32Array(l)}this.$texCoords=h}else{var s=c.length;c.BYTES_PER_ELEMENT?this.$texCoords=c:this.$texCoordsLength==s?this.$texCoords.set(c):this.$texCoords=new Float32Array(c),this.$texCoordsLength=s}},get:function(){return this.$texCoords}},indices:{set:function(c){if(!c){delete this.$indices,delete this.$indicesLength;return}var h=c.length;c.BYTES_PER_ELEMENT?this.$indices=c:this.$indicesLength==h?this.$indices.set(c):this.$indices=new Uint16Array(c),this.$indicesLength=h},get:function(){return this.$indices}}}),x.extend(e.Model.prototype,{$$family:"model",update:function(){var c=this.matrix,h=this.position,o=this.rotation,l=this.scale;c.id(),c.$translate(h.x,h.y,h.z),c.$rotateXYZ(o.x,o.y,o.z),c.$scale(l.x,l.y,l.z)},computeCentroids:function(){var c=this.faces,h=this.vertices,o=[];c.forEach(function(l){var s=[0,0,0],u=0;l.forEach(function(a){var b=h[a];s[0]+=b[0],s[1]+=b[1],s[2]+=b[2],u++}),s[0]/=u,s[1]/=u,s[2]/=u,o.push(s)}),this.centroids=o},computeNormals:function(){var c=this.faces,h=this.vertices,o=[];c.forEach(function(l){var s=h[l[0]],u=h[l[1]],a=h[l[2]],b={x:a[0]-u[0],y:a[1]-u[1],z:a[1]-u[2]},f={x:s[0]-u[0],y:s[1]-u[1],z:s[2]-u[2]};y.$cross(f,b),y.norm(f)>1e-6&&y.unit(f),o.push([f.x,f.y,f.z])}),this.normals=o}}),x.extend(e.Model.prototype,p),e.Cube=function(c){e.Model.call(this,x.extend({vertices:[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],texCoords:[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1],normals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},c||{}))},e.Cube.prototype=Object.create(e.Model.prototype),e.Sphere=function(c){var h=c.nlat||10,o=c.nlong||10,l=c.radius||1,s=0,u=q,a=u-s,b=0,f=2*q,j=f-b,m=(h+1)*(o+1),r=new Float32Array(m*3),w=new Float32Array(m*3),z=new Float32Array(m*2),v=new Uint16Array(h*o*6);if(typeof l=="number"){var A=l;l=function(W,S,X,Y,Z){return A}}for(var C=0;C<=h;C++)for(var F=0;F<=o;F++){var I=F/o,D=C/h,H=j*I,J=a*D,P=g(H),V=t(H),L=g(J),K=t(J),E=V*L,M=K,Q=P*L,R=l(E,M,Q,I,D),G=F+C*(o+1),O=G*3,T=G*2;r[O+0]=R*E,r[O+1]=R*M,r[O+2]=R*Q,w[O+0]=E,w[O+1]=M,w[O+2]=Q,z[T+0]=I,z[T+1]=D}var N=h+1;for(F=0;F<h;F++)for(C=0;C<o;C++){var G=(F*o+C)*6;v[G+0]=C*N+F,v[G+1]=C*N+F+1,v[G+2]=(C+1)*N+F,v[G+3]=(C+1)*N+F,v[G+4]=C*N+F+1,v[G+5]=(C+1)*N+F+1}e.Model.call(this,x.extend({vertices:r,indices:v,normals:w,texCoords:z},c||{}))},e.Sphere.prototype=Object.create(e.Model.prototype),e.IcoSphere=function(c){var h=c.iterations||0,o=[],l=[],s=Math.sqrt,u=Math.acos,a=Math.atan2,b=Math.PI,f=b*2;c.onAddVertex=c.onAddVertex||x.empty;var j=(1+s(5))/2,m=s(1+j*j);o.push(-1/m,j/m,0,1/m,j/m,0,-1/m,-j/m,0,1/m,-j/m,0,0,-1/m,j/m,0,1/m,j/m,0,-1/m,-j/m,0,1/m,-j/m,j/m,0,-1/m,j/m,0,1/m,-j/m,0,-1/m,-j/m,0,1/m),l.push(0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1);for(var r=function(){var ja={};return function($,aa){$*=3,aa*=3;var wa=$<aa?$:aa,xa=$>aa?$:aa,ka=wa+"|"+xa;if(ka in ja)return ja[ka];var ya=o[$],za=o[$+1],Aa=o[$+2],Ba=o[aa],Ca=o[aa+1],Da=o[aa+2],fa=(ya+Ba)/2,ga=(za+Ca)/2,ha=(Aa+Da)/2,la=s(fa*fa+ga*ga+ha*ha);return fa/=la,ga/=la,ha/=la,o.push(fa,ga,ha),ja[ka]=o.length/3-1}}(),w=0;w<h;w++){for(var z=[],v=0,A=l.length;v<A;v+=3){var C=r(l[v],l[v+1]),F=r(l[v+1],l[v+2]),I=r(l[v+2],l[v]);z.push(l[v],C,I,l[v+1],F,C,l[v+2],I,F,C,F,I)}l=z}for(var A=l.length,D=new Float32Array(A*3),H=new Float32Array(A*2),w=0;w<A;w+=3){var J=l[w],P=l[w+1],V=l[w+2],L=J*3,K=P*3,E=V*3,M=J*2,Q=P*2,R=V*2,G=o[L],O=o[L+1],T=o[L+2],N=u(T/s(G*G+O*O+T*T)),W=a(O,G),S=N/b,X=1-W/f,Y=o[K],Z=o[K+1],_=o[K+2],ba=u(_/s(Y*Y+Z*Z+_*_)),na=a(Z,Y),oa=ba/b,pa=1-na/f,ca=o[E],da=o[E+1],ea=o[E+2],qa=u(ea/s(ca*ca+da*da+ea*ea)),ra=a(da,ca),sa=qa/b,ta=1-ra/f,ua={x:ca-Y,y:da-Z,z:ea-_},va={x:G-Y,y:O-Z,z:T-_},ia=y.cross(ua,va).$unit();D[L]=D[K]=D[E]=ia.x,D[L+1]=D[K+1]=D[E+1]=ia.y,D[L+2]=D[K+2]=D[E+2]=ia.z,H[M]=X,H[M+1]=S,H[Q]=pa,H[Q+1]=oa,H[R]=ta,H[R+1]=sa}e.Model.call(this,x.extend({vertices:o,indices:l,normals:D,texCoords:H},c||{}))},e.IcoSphere.prototype=Object.create(e.Model.prototype),e.TruncatedCone=function(c){for(var h=c.bottomRadius||0,o=c.topRadius||0,l=c.height||1,s=c.nradial||10,u=c.nvertical||10,a=!!c.topCap,b=!!c.bottomCap,f=(a?2:0)+(b?2:0),j=(s+1)*(u+1+f),m=new Float32Array(j*3),r=new Float32Array(j*3),w=new Float32Array(j*2),z=new Uint16Array(s*(u+f)*6),v=s+1,A=Math,C=A.atan2(h-o,l),F=A.sin,I=A.cos,D=A.PI,H=I(C),J=F(C),P=a?-2:0,V=u+(b?2:0),L=0,K=0,E=P;E<=V;E++){var M=E/u,Q=l*M,R;E<0?(Q=0,M=1,R=h):E>u?(Q=l,M=1,R=o):R=h+(o-h)*(E/u),(E==-2||E==u+2)&&(R=0,M=0),Q-=l/2;for(var G=0;G<v;G++){var O=F(G*D*2/s),T=I(G*D*2/s);m[L+0]=O*R,m[L+1]=Q,m[L+2]=T*R,r[L+0]=E<0||E>u?0:O*H,r[L+1]=E<0?-1:E>u?1:J,r[L+2]=E<0||E>u?0:T*H,w[K+0]=G/s,w[K+1]=M,K+=2,L+=3}}for(E=0;E<u+f;E++)for(G=0;G<s;G++){var N=(E*s+G)*6;z[N+0]=v*(E+0)+0+G,z[N+1]=v*(E+0)+1+G,z[N+2]=v*(E+1)+1+G,z[N+3]=v*(E+0)+0+G,z[N+4]=v*(E+1)+1+G,z[N+5]=v*(E+1)+0+G}e.Model.call(this,x.extend({vertices:m,normals:r,texCoords:w,indices:z},c||{}))},e.TruncatedCone.prototype=Object.create(e.Model.prototype),e.Cone=function(c){c.topRadius=0,c.topCap=!!c.cap,c.bottomCap=!!c.cap,c.bottomRadius=c.radius||3,e.TruncatedCone.call(this,c)},e.Cone.prototype=Object.create(e.TruncatedCone.prototype),e.Cylinder=function(c){c.bottomRadius=c.radius,c.topRadius=c.radius,e.TruncatedCone.call(this,c)},e.Cylinder.prototype=Object.create(e.TruncatedCone.prototype),e.Plane=function(c){var h=c.type,o=h.split(","),l=c[o[0]+"len"],s=c[o[1]+"len"],u=c["n"+o[0]]||1,a=c["n"+o[1]]||1,b=c.offset,f=!!c.flipCull,j=(u+1)*(a+1),m=new Float32Array(j*3),r=new Float32Array(j*3),w=new Float32Array(j*2),z=0,v=0;f&&(l=-l);for(var A=0;A<=a;A++)for(var C=0;C<=u;C++){var F=C/u,I=A/a;f?w[z+0]=1-F:w[z+0]=F,w[z+1]=I,z+=2;switch(h){case"x,y":m[v+0]=l*F-l*.5,m[v+1]=s*I-s*.5,m[v+2]=b,r[v+0]=0,r[v+1]=0,f?r[v+2]=1:r[v+2]=-1;break;case"x,z":m[v+0]=l*F-l*.5,m[v+1]=b,m[v+2]=s*I-s*.5,r[v+0]=0,f?r[v+1]=1:r[v+1]=-1,r[v+2]=0;break;case"y,z":m[v+0]=b,m[v+1]=l*F-l*.5,m[v+2]=s*I-s*.5,f?r[v+0]=1:r[v+0]=-1,r[v+1]=0,r[v+2]=0;break}v+=3}var D=u+1,H=[];for(A=0;A<a;A++)for(C=0;C<u;C++){var J=(A*u+C)*6;H[J+0]=(A+0)*D+C,H[J+1]=(A+1)*D+C,H[J+2]=(A+0)*D+C+1,H[J+3]=(A+1)*D+C,H[J+4]=(A+1)*D+C+1,H[J+5]=(A+0)*D+C+1}e.Model.call(this,x.extend({vertices:m,normals:r,texCoords:w,indices:H},c))},e.Plane.prototype=Object.create(e.Model.prototype),e.id=x.time(),PhiloGL.O3D=e}(),function(){var y={Vertex:{},Fragment:{}},B=y.Vertex,t=y.Fragment;B.Default=["#define LIGHT_MAX 4","attribute vec3 position;","attribute vec3 normal;","attribute vec4 color;","attribute vec4 pickingColor;","attribute vec2 texCoord1;","uniform mat4 viewMatrix;","uniform mat4 viewInverseMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 worldInverseMatrix;","uniform mat4 worldInverseTransposeMatrix;","uniform mat4 objectMatrix;","uniform vec3 cameraPosition;","uniform bool enableLights;","uniform vec3 ambientColor;","uniform vec3 directionalColor;","uniform vec3 lightingDirection;","uniform vec3 pointLocation[LIGHT_MAX];","uniform vec3 pointColor[LIGHT_MAX];","uniform int numberPoints;","uniform bool useReflection;","varying vec3 vReflection;","varying vec4 vColor;","varying vec4 vPickingColor;","varying vec2 vTexCoord;","varying vec4 vNormal;","varying vec3 lightWeighting;","void main(void) {","vec4 mvPosition = worldMatrix * vec4(position, 1.0);","vec4 transformedNormal = worldInverseTransposeMatrix * vec4(normal, 1.0);","if(!enableLights) {","lightWeighting = vec3(1.0, 1.0, 1.0);","} else {","vec3 plightDirection;","vec3 pointWeight = vec3(0.0, 0.0, 0.0);","float directionalLightWeighting = max(dot(transformedNormal.xyz, lightingDirection), 0.0);","for (int i = 0; i < LIGHT_MAX; i++) {","if (i < numberPoints) {","plightDirection = normalize((viewMatrix * vec4(pointLocation[i], 1.0)).xyz - mvPosition.xyz);","pointWeight += max(dot(transformedNormal.xyz, plightDirection), 0.0) * pointColor[i];","} else {","break;","}","}","lightWeighting = ambientColor + (directionalColor * directionalLightWeighting) + pointWeight;","}","if (useReflection) {","vReflection = (viewInverseMatrix[3] - (worldMatrix * vec4(position, 1.0))).xyz;","} else {","vReflection = vec3(1.0, 1.0, 1.0);","}","vColor = color;","vPickingColor = pickingColor;","vTexCoord = texCoord1;","vNormal = transformedNormal;","gl_Position = projectionMatrix * worldMatrix * vec4(position, 1.0);","}"].join(`
`),t.Default=["#ifdef GL_ES","precision highp float;","#endif","varying vec4 vColor;","varying vec4 vPickingColor;","varying vec2 vTexCoord;","varying vec3 lightWeighting;","varying vec3 vReflection;","varying vec4 vNormal;","uniform bool hasTexture1;","uniform sampler2D sampler1;","uniform bool hasTextureCube1;","uniform samplerCube samplerCube1;","uniform bool enablePicking;","uniform bool hasPickingColors;","uniform vec3 pickColor;","uniform float reflection;","uniform float refraction;","uniform bool hasFog;","uniform vec3 fogColor;","uniform float fogNear;","uniform float fogFar;","void main(){","if (!hasTexture1) {","gl_FragColor = vec4(vColor.rgb * lightWeighting, vColor.a);","} else {","gl_FragColor = vec4(texture2D(sampler1, vec2(vTexCoord.s, vTexCoord.t)).rgb * lightWeighting, 1.0);","}","if (hasTextureCube1) {","vec3 nReflection = normalize(vReflection);","vec3 reflectionValue;","if (refraction > 0.0) {","reflectionValue = refract(nReflection, vNormal.xyz, refraction);","} else {","reflectionValue = -reflect(nReflection, vNormal.xyz);","}","vec4 cubeColor = textureCube(samplerCube1, vec3(-reflectionValue.x, -reflectionValue.y, reflectionValue.z));","gl_FragColor = vec4(mix(gl_FragColor.xyz, cubeColor.xyz, reflection), 1.0);","}","if (enablePicking) {","if (hasPickingColors) {","gl_FragColor = vPickingColor;","} else {","gl_FragColor = vec4(pickColor, 1.0);","}","}","if (hasFog) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = smoothstep(fogNear, fogFar, depth);","gl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w), fogFactor);","}","}"].join(`
`),PhiloGL.Shaders=y}(),function(){var y=PhiloGL.Vec3,B=PhiloGL.Mat4,t=function(g,q,i){i=x.merge({lights:{enable:!1,ambient:{r:.2,g:.2,b:.2},directional:{direction:{x:1,y:1,z:1},color:{r:0,g:0,b:0}}},effects:{fog:!1}},i||{}),this.program=i.program?g[i.program]:g,this.camera=q,this.models=[],this.config=i};t.prototype={add:function(){for(var g=0,q=this.models,i=arguments.length;g<i;g++){var d=arguments[g];d.id=d.id||x.uid(),q.push(d),this.defineBuffers(d)}},remove:function(g){var q=this.models,i=q.indexOf(g);i>-1&&q.splice(i,1)},getProgram:function(g){var q=this.program;return q.$$family!="program"&&g&&g.program?(q=q[g.program],q.use(),q):q},defineBuffers:function(g){var q=this.getProgram(g),i=g.dynamic;g.dynamic=!0,g.setState(q),g.dynamic=i,g.unsetState(q)},beforeRender:function(g){this.setupLighting(g),this.setupEffects(g),this.camera&&this.camera.setStatus(g)},setupLighting:function(g){var q=Math.abs,i=this.camera,d=i.position,k=this.config.lights,e=k.ambient,p=k.directional,c=p.color,h=p.direction,o=k.enable,l=k.points&&x.splat(k.points)||[],s=l.length,u=[],a=[],b=[],f=[];h=new y(h.x,h.y,h.z).$unit().$scale(-1),g.setUniform("enableLights",o);if(!o)return;g.setUniform("ambientColor",[e.r,e.g,e.b]),g.setUniform("directionalColor",[c.r,c.g,c.b]),g.setUniform("lightingDirection",[h.x,h.y,h.z]),g.setUniform("numberPoints",s);for(var j=0,m=s;j<m;j++){var r=l[j],w=r.position,z=r.color||r.diffuse,v=r.specular;u.push(w.x,w.y,w.z),a.push(z.r,z.g,z.b),b.push(+!!v),v?f.push(v.r,v.g,v.b):f.push(0,0,0)}u.length&&(g.setUniforms({pointLocation:u,pointColor:a}),g.setUniforms({enableSpecular:b,pointSpecularColor:f}))},setupEffects:function(g){var q=this.config.effects,i=q.fog,d=i.color||{r:.5,g:.5,b:.5};i?g.setUniforms({hasFog:!0,fogNear:i.near,fogFar:i.far,fogColor:[d.r,d.g,d.b]}):g.setUniform("hasFog",!1)},render:function(g){g=g||{};var q=this.camera,i=this.program,d=g.renderProgram,k=x.type(i),e=!d&&k=="object",p=x.extend({onBeforeRender:x.empty,onAfterRender:x.empty},g||{});!e&&this.beforeRender(d||i);for(var c=0,h=this.models,o=h.length;c<o;++c){var l=h[c];if(l.display){var i=d||this.getProgram(l);e&&this.beforeRender(i),l.onBeforeRender(i,q),p.onBeforeRender(l,c),this.renderObject(l,i),p.onAfterRender(l,c),l.onAfterRender(i,q)}}},renderToTexture:function(g,q){q=q||{};var i=U.textures[g+"-texture"],d=U.textureMemo[g+"-texture"];this.render(q),n.bindTexture(d.textureType,i)},renderObject:function(g,q){var i=this.camera,d=i.view,k=i.projection,e=g.matrix,p=d.mulMat4(e),c=p.invert(),h=c.transpose();g.setState(q),q.setUniforms({objectMatrix:e,worldMatrix:p,worldInverseMatrix:c,worldInverseTransposeMatrix:h}),g.render?g.render(n,q,i):g.$indicesLength?n.drawElements(g.drawType!==void 0?n.get(g.drawType):n.TRIANGLES,g.$indicesLength,n.UNSIGNED_SHORT,0):n.drawArrays(g.drawType!==void 0?n.get(g.drawType):n.TRIANGLES,0,g.$verticesLength/3),g.unsetState(q)},setupPicking:function(){var g=PhiloGL.Program.fromDefaultShaders(),q=Math.floor;U.setFrameBuffer("$picking",{width:5,height:1,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR"},{name:"TEXTURE_WRAP_S",value:"CLAMP_TO_EDGE"},{name:"TEXTURE_WRAP_T",value:"CLAMP_TO_EDGE"}]},bindToRenderBuffer:!0}),U.setFrameBuffer("$picking",!1),this.pickingProgram=g},pick:function(g,q,i){i=i||{},this.pickingProgram||this.setupPicking();var d={},k=[],e=U.usedProgram,p=this.pickingProgram,c=this.camera,h=c.target,o=c.aspect,l=this.config,s=l.lights.enable,u=l.effects.fog,a=n.canvas,b=i.viewport||{},f=b.width||a.offsetWidth||a.width,j=b.height||a.offsetHeight||a.height,m=Math.floor,r=5,w=1,z=g-(b.x||0),v=q-(b.y||0),A=z*2/f-1,C=1-v*2/j,F=this.unproject([A,C,1],c),I=[],D=new Uint8Array(1*1*4),H=0,J,P,V;this.camera.target=F,this.camera.update(),l.lights.enable=!1,l.effects.fog=!1,U.setFrameBuffer("$picking",!0),p.use(),p.setUniform("enablePicking",!0),n.disable(n.BLEND),n.viewport(0,0,r,w),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.readPixels(0,0,1,1,n.RGBA,n.UNSIGNED_BYTE,D),J=D[0]+D[1]*256+D[2]*256*256,this.renderPickingScene({background:J,o3dHash:d,o3dList:k,hash:I}),n.readPixels(2,0,1,1,n.RGBA,n.UNSIGNED_BYTE,D);var L=[D[0],D[1],D[2]].join(),K=d[L],E;console.log("o3dHash",L,g,q,f,j);if(!K)for(var M=0,Q=k.length;M<Q;M++)K=k[M],E=K.pick(D),E!==!1?K.$pickingIndex=E:K=!1;return U.setFrameBuffer("$picking",!1),U.setTexture("$picking-texture",!1),p.setUniform("enablePicking",!1),l.lights.enable=s,l.effects.fog=u,e&&e.use(),n.viewport(b.x||0,b.y||0,f,j),c.target=h,c.aspect=o,c.update(),this.o3dHash=d,this.o3dList=k,this.pixel=D,this.capture=P,K&&K.pickable&&K},unproject:function(g,q){return q.view.invert().mulMat4(q.projection.invert()).mulVec3(g)},renderPickingScene:function(g){if(this.config.renderPickingScene){this.config.renderPickingScene.call(this,g);return}var q=this.pickingProgram,i=g.o3dHash,d=g.o3dList,k=g.background,e=g.hash,p=0;this.renderToTexture("$picking",{renderProgram:q,onBeforeRender:function(c,h){h==k&&(p=1);var o=h+p,l=!!c.pickingColors;q.setUniform("hasPickingColors",l),l?d.push(c):(e[0]=o%256,e[1]=(o/256>>0)%256,e[2]=(o/(256*256)>>0)%256,q.setUniform("pickColor",[e[0]/255,e[1]/255,e[2]/255]),i[e.join()]=c)}})},resetPicking:x.empty},t.MAX_TEXTURES=10,t.MAX_POINT_LIGHTS=4,t.PICKING_RES=4,PhiloGL.Scene=t}(),function(){function y(B,t){for(var g=this.workers=[];t--;)g.push(new Worker(B))}y.prototype={map:function(B){for(var t=this.workers,g=this.configs=[],q=0,i=t.length;q<i;q++)g.push(B&&B(q));return this},reduce:function(B){for(var t=B.reduceFn,g=this.workers,q=this.configs,i=g.length,d=B.initialValue,k=function(h){i--,d===void 0?d=h.data:d=t(d,h.data),i==0&&B.onComplete(d)},e=0,p=i;e<p;e++){var c=g[e];c.onmessage=k,c.postMessage(q[e])}return this}},PhiloGL.WorkerGroup=y}(),function(){var y=function(d){this.opt=x.merge({delay:0,duration:1e3,transition:function(k){return k},onCompute:x.empty,onComplete:x.empty},d||{})},B=y.Queue=[];y.prototype={time:null,start:function(d){this.opt=x.merge(this.opt,d||{}),this.time=x.time(),this.animating=!0,B.push(this)},step:function(){if(!this.animating)return;var d=x.time(),k=this.time,e=this.opt,p=e.delay,c=e.duration,h=0;if(d<k+p){e.onCompute.call(this,h);return}d<k+p+c?(h=e.transition((d-k-p)/c),e.onCompute.call(this,h)):(this.animating=!1,e.onCompute.call(this,1),e.onComplete.call(this))}},y.compute=function(d,k,e){return d+(k-d)*e},y.Transition={linear:function(d){return d}};var t=y.Transition;(function(){var d=function(p,c){return c=x.splat(c),x.extend(p,{easeIn:function(h){return p(h,c)},easeOut:function(h){return 1-p(1-h,c)},easeInOut:function(h){return h<=.5?p(2*h,c)/2:(2-p(2*(1-h),c))/2}})},k={Pow:function(p,c){return Math.pow(p,c[0]||6)},Expo:function(p){return Math.pow(2,8*(p-1))},Circ:function(p){return 1-Math.sin(Math.acos(p))},Sine:function(p){return 1-Math.sin((1-p)*Math.PI/2)},Back:function(p,c){return c=c[0]||1.618,Math.pow(p,2)*((c+1)*p-c)},Bounce:function(p){for(var c,h=0,o=1;;h+=o,o/=2)if(p>=(7-4*h)/11){c=o*o-Math.pow((11-6*h-11*p)/4,2);break}return c},Elastic:function(p,c){return Math.pow(2,10*--p)*Math.cos(20*p*Math.PI*(c[0]||1)/3)}};for(var e in k)t[e]=d(k[e]);["Quad","Cubic","Quart","Quint"].forEach(function(p,c){t[p]=d(function(h){return Math.pow(h,[c+2])})})})();var g=self||window,q=function(){var d=B;B=[];if(d.length){for(var k=0,e=d.length,p;k<e;k++)p=d[k],p.step(),p.animating&&B.push(p);y.Queue=B}};if(g){var i=!1;["webkitAnimationTime","mozAnimationTime","animationTime","webkitAnimationStartTime","mozAnimationStartTime","animationStartTime"].forEach(function(d){d in g&&(y.animationTime=function(){return g[d]},i=!0)}),i||(y.animationTime=x.time),i=!1,["webkitRequestAnimationFrame","mozRequestAnimationFrame","requestAnimationFrame"].forEach(function(d){d in g&&(y.requestAnimationFrame=function(k){g[d](function(){q(),k()})},i=!0)}),i||(y.requestAnimationFrame=function(d){setTimeout(function(){q(),d()},1e3/60)})}PhiloGL.Fx=y}(),function(){var y={},B=function(){};B.postProcess=function(){var t=new PhiloGL.O3D.Plane({type:"x,y",xlen:1,ylen:1,offset:0}),g=new PhiloGL.Camera(45,1,.1,500,{position:{x:0,y:0,z:1.205}}),q=new PhiloGL.Scene({},g);return function(i){var d=U.program.$$family?U.program:U.program[i.program],k=i.fromTexture?x.splat(i.fromTexture):[],e=i.toFrameBuffer,p=!!i.toScreen,c=i.width||U.canvas.width,h=i.height||U.canvas.height,o=i.viewportX||0,l=i.viewportY||0;return g.aspect=i.aspectRatio?i.aspectRatio:Math.max(h/c,c/h),g.update(),q.program=d,t.textures=k,t.program=d,q.models.length||q.add(t),e&&(e in U.frameBufferMemo||U.setFrameBuffer(e,{width:c,height:h,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR",generateMipmap:!1}]},bindToRenderBuffer:!1}),d.use(),U.setFrameBuffer(e,!0),n.viewport(o,l,c,h),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),d.setUniforms(i.uniforms||{}),q.renderToTexture(e),U.setFrameBuffer(e,!1)),p&&(d.use(),n.viewport(o,l,c,h),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),d.setUniforms(i.uniforms||{}),q.render()),this}}(),y.Image=B,PhiloGL.Media=y}(),this.PhiloGL=PhiloGL})();
